@page "/payment/{OrderId?}"
@using WebUI.Models
@using WebUI.Services
@using WebUI.Services.Interfaces
@inject OrderService OrderService
@inject IPaymentService PaymentService
@inject CartService CartService
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject IToastService ToastService
@inject IJSRuntime JSRuntime

@* Unified minimal theme styles are in asion.css *@

<div class="payment-page">
    <div class="payment-container">
        <!-- Back Link -->
        <a href="/checkout" class="back-link">
            <i class="fas fa-arrow-left"></i>
            Quay l·∫°i th√¥ng tin giao h√†ng
        </a>

        <div class="payment-header">
            <h1 class="payment-title">Thanh to√°n</h1>
        </div>

        <!-- Progress Steps -->
        <div class="progress-steps">
            <div class="step completed">
                <div class="step-circle"><i class="fas fa-check"></i></div>
                <span class="step-label">Gi·ªè h√†ng</span>
            </div>
            <div class="step-divider active"></div>
            <div class="step completed">
                <div class="step-circle"><i class="fas fa-check"></i></div>
                <span class="step-label">Th√¥ng tin</span>
            </div>
            <div class="step-divider active"></div>
            <div class="step active">
                <div class="step-circle">3</div>
                <span class="step-label">Thanh to√°n</span>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="payment-progress">
            <div class="payment-progress-bar"></div>
        </div>

        @if (IsProcessing)
        {
            <div class="payment-status processing">
                <div class="payment-status-icon">
                    <i class="fas fa-spinner"></i>
                </div>
                <h2 class="payment-status-title">ƒêang x·ª≠ l√Ω thanh to√°n...</h2>
                <p class="payment-status-message">Vui l√≤ng ƒë·ª£i trong gi√¢y l√°t</p>
            </div>
        }
        else if (PaymentStatus == "success")
        {
            <div class="payment-status success">
                <div class="payment-status-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h2 class="payment-status-title">Thanh to√°n th√†nh c√¥ng!</h2>
                <p class="payment-status-message">ƒê∆°n h√†ng c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n</p>
                <button class="btn-complete" @onclick='() => Navigation.NavigateTo("/")'>
                    <i class="fas fa-home"></i>
                    Tr·ªü v·ªÅ trang ch·ªß
                </button>
            </div>
        }
        else if (PaymentStatus == "failed")
        {
            <div class="payment-status failed">
                <div class="payment-status-icon">
                    <i class="fas fa-times-circle"></i>
                </div>
                <h2 class="payment-status-title">Thanh to√°n th·∫•t b·∫°i</h2>
                <p class="payment-status-message">Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n kh√°c</p>
                <button class="btn-continue" @onclick='() => PaymentStatus = ""'>
                    <i class="fas fa-redo"></i>
                    Th·ª≠ l·∫°i
                </button>
            </div>
        }
        else
        {
            <div style="display: flex; flex-direction: column; gap: 24px; max-width: 800px; margin: 0 auto;">
                <!-- Payment Details -->
                <div class="payment-methods-section">
                    <!-- Shipping Info Card -->
                    <div class="shipping-info-card">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h3 class="info-title">
                                <i class="fas fa-shipping-fast"></i>
                                Th√¥ng tin giao h√†ng
                            </h3>
                            <button class="btn-edit" @onclick='() => Navigation.NavigateTo("/checkout")'>
                                <i class="fas fa-edit"></i> S·ª≠a
                            </button>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Ng∆∞·ªùi nh·∫≠n:</span>
                            <span class="info-value">@ReceiverName</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">S·ªë ƒëi·ªán tho·∫°i:</span>
                            <span class="info-value">@ReceiverPhone</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ƒê·ªãa ch·ªâ:</span>
                            <span class="info-value">@ShippingAddress</span>
                        </div>
                    </div>

                    <!-- Payment Method Selection -->
                    <div class="payment-card">
                        <h2 class="card-title">
                            <i class="fas fa-credit-card card-icon"></i>
                            Ph∆∞∆°ng th·ª©c thanh to√°n
                        </h2>

                        <div class="payment-options">
                            <!-- COD -->
                            <div class="payment-option @(SelectedPaymentMethod == "cod" ? "selected" : "")"
                                 @onclick='() => SelectedPaymentMethod = "cod"'>
                                <div class="payment-radio"></div>
                                <div class="payment-icon-wrapper">üíµ</div>
                                <div class="payment-info">
                                    <div class="payment-method-name">Thanh to√°n khi nh·∫≠n h√†ng (COD)</div>
                                    <div class="payment-method-description">Thanh to√°n b·∫±ng ti·ªÅn m·∫∑t khi nh·∫≠n h√†ng</div>
                                </div>
                                <div class="payment-fee">+15.000ƒë</div>
                            </div>

                            <!-- Banking Transfer -->
                            <div class="payment-option @(SelectedPaymentMethod == "banking" ? "selected" : "")"
                                 @onclick='() => SelectedPaymentMethod = "banking"'>
                                <div class="payment-radio"></div>
                                <div class="payment-icon-wrapper">üè¶</div>
                                <div class="payment-info">
                                    <div class="payment-method-name">Chuy·ªÉn kho·∫£n ng√¢n h√†ng</div>
                                    <div class="payment-method-description">Chuy·ªÉn kho·∫£n qua Internet Banking</div>
                                </div>
                                <div class="payment-fee">Mi·ªÖn ph√≠</div>
                            </div>

                            @if (SelectedPaymentMethod == "banking")
                            {
                                <div class="payment-details">
                                    <div class="bank-info">
                                        <div class="bank-info-row">
                                            <span class="bank-label">Ng√¢n h√†ng:</span>
                                            <span class="bank-value">Vietcombank</span>
                                        </div>
                                        <div class="bank-info-row">
                                            <span class="bank-label">S·ªë t√†i kho·∫£n:</span>
                                            <span class="bank-value">
                                                1234567890
                                                <button class="btn-copy" @onclick='() => CopyToClipboard("1234567890")'>
                                                    Copy
                                                </button>
                                            </span>
                                        </div>
                                        <div class="bank-info-row">
                                            <span class="bank-label">Ch·ªß TK:</span>
                                            <span class="bank-value">C√îNG TY ASION</span>
                                        </div>
                                        <div class="bank-info-row">
                                            <span class="bank-label">N·ªôi dung:</span>
                                            <span class="bank-value">
                                                ORD-@OrderNumber
                                                <button class="btn-copy" @onclick='() => CopyToClipboard($"ORD-{OrderNumber}")'>
                                                    Copy
                                                </button>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            }

                            <!-- Momo -->
                            <div class="payment-option @(SelectedPaymentMethod == "momo" ? "selected" : "")"
                                 @onclick='() => SelectedPaymentMethod = "momo"'>
                                <div class="payment-radio"></div>
                                <div class="payment-icon-wrapper">üì±</div>
                                <div class="payment-info">
                                    <div class="payment-method-name">V√≠ MoMo</div>
                                    <div class="payment-method-description">Qu√©t m√£ QR ƒë·ªÉ thanh to√°n</div>
                                </div>
                                <div class="payment-fee">Mi·ªÖn ph√≠</div>
                            </div>

                            @if (SelectedPaymentMethod == "momo")
                            {
                                <div class="payment-details">
                                    <div class="qr-code-section">
                                        <div class="qr-code-image" style="background: var(--gray-200); display:flex; align-items:center; justify-content:center; color: var(--gray-500);">
                                            QR Code
                                        </div>
                                        <p class="qr-instruction">Qu√©t m√£ QR b·∫±ng ·ª©ng d·ª•ng MoMo</p>
                                    </div>
                                </div>
                            }

                            <!-- ZaloPay -->
                            <div class="payment-option @(SelectedPaymentMethod == "zalopay" ? "selected" : "")"
                                 @onclick='() => SelectedPaymentMethod = "zalopay"'>
                                <div class="payment-radio"></div>
                                <div class="payment-icon-wrapper">üíô</div>
                                <div class="payment-info">
                                    <div class="payment-method-name">ZaloPay</div>
                                    <div class="payment-method-description">Thanh to√°n an to√†n v·ªõi ZaloPay</div>
                                </div>
                                <div class="payment-fee">Mi·ªÖn ph√≠</div>
                            </div>

                            <!-- Credit Card -->
                            <div class="payment-option @(SelectedPaymentMethod == "card" ? "selected" : "")"
                                 @onclick='() => SelectedPaymentMethod = "card"'>
                                <div class="payment-radio"></div>
                                <div class="payment-icon-wrapper">üí≥</div>
                                <div class="payment-info">
                                    <div class="payment-method-name">Th·∫ª t√≠n d·ª•ng/Ghi n·ª£</div>
                                    <div class="payment-method-description">Visa, MasterCard, JCB</div>
                                </div>
                                <div class="payment-fee">Mi·ªÖn ph√≠</div>
                            </div>

                            @if (SelectedPaymentMethod == "card")
                            {
                                <div class="payment-details">
                                    <div class="card-form">
                                        <div class="form-group">
                                            <label class="form-label">S·ªë th·∫ª</label>
                                            <input type="text" class="form-input" placeholder="1234 5678 9012 3456" />
                                        </div>
                                        <div class="card-row">
                                            <div class="form-group">
                                                <label class="form-label">Ng√†y h·∫øt h·∫°n</label>
                                                <input type="text" class="form-input" placeholder="MM/YY" />
                                            </div>
                                            <div class="form-group">
                                                <label class="form-label">CVV</label>
                                                <input type="text" class="form-input" placeholder="123" />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>

                </div>

                <!-- Order Summary -->
                <div class="summary-card" style="max-width: 100%;">
                    <h3 class="summary-header">T√≥m t·∫Øt ƒë∆°n h√†ng</h3>
                    <div class="summary-divider"></div>
                    <div class="summary-row">
                        <span class="summary-label">T·∫°m t√≠nh</span>
                        <span class="summary-value">@SubTotal.ToString("N0")ƒë</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Ph√≠ v·∫≠n chuy·ªÉn</span>
                        <span class="summary-value">@ShippingFee.ToString("N0")ƒë</span>
                    </div>
                    @if (SelectedPaymentMethod == "cod")
                    {
                        <div class="summary-row">
                            <span class="summary-label">Ph√≠ thu h·ªô COD</span>
                            <span class="summary-value">15.000ƒë</span>
                        </div>
                    }
                    @if (Discount > 0)
                    {
                        <div class="summary-row discount">
                            <span class="summary-label">Gi·∫£m gi√°</span>
                            <span class="summary-value">-@Discount.ToString("N0")ƒë</span>
                        </div>
                    }
                    <div class="summary-divider"></div>
                    <div class="summary-row total">
                        <span class="summary-label">T·ªïng c·ªông</span>
                        <span class="summary-value">@GetFinalTotal()</span>
                    </div>
                    <div class="terms-section">
                        <input type="checkbox" class="terms-checkbox" @bind="AgreeTerms" id="agreeTerms" />
                        <label for="agreeTerms" class="terms-text">
                            T√¥i ƒë·ªìng √Ω v·ªõi <a href="#" class="terms-link">ƒêi·ªÅu kho·∫£n & ƒêi·ªÅu ki·ªán</a> c·ªßa Asion
                        </label>
                    </div>
                    <button class="btn-confirm-payment" 
                            @onclick="HandlePayment"
                            disabled="@(!AgreeTerms || IsProcessing)">
                        <i class="fas fa-lock"></i>
                        <span>X√°c nh·∫≠n thanh to√°n</span>
                    </button>
                    <div class="security-badge">
                        <i class="fas fa-shield-alt security-icon"></i>
                        <span>Giao d·ªãch b·∫£o m·∫≠t SSL</span>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@code {
    [Parameter]
    public string? OrderId { get; set; }

    private string OrderNumber = DateTime.Now.Ticks.ToString().Substring(8);
    private string ReceiverName = string.Empty;
    private string ReceiverPhone = string.Empty;
    private string ShippingAddress = string.Empty;
    
    private string SelectedPaymentMethod = "cod";
    private bool AgreeTerms = false;
    private bool IsProcessing = false;
    private string PaymentStatus = ""; // "", "processing", "success", "failed"
    
    private decimal SubTotal = 0;
    private decimal ShippingFee = 0;
    private decimal Discount = 0;
    private int? CreatedOrderId = null;

    protected override void OnInitialized()
    {
        // L·∫•y th√¥ng tin t·ª´ Checkout
        var checkoutInfo = CartService.CheckoutInfo;
        if (checkoutInfo == null)
        {
            // N·∫øu kh√¥ng c√≥ th√¥ng tin checkout, quay l·∫°i trang checkout
            Navigation.NavigateTo("/checkout");
            return;
        }

        ReceiverName = checkoutInfo.FullName;
        ReceiverPhone = checkoutInfo.Phone;
        ShippingAddress = $"{checkoutInfo.Address}, {checkoutInfo.City}";
        SubTotal = checkoutInfo.Subtotal;
        ShippingFee = checkoutInfo.ShippingFee;
    }

    private async Task HandlePayment()
    {
        if (!AgreeTerms)
        {
            await ToastService.ShowError("Vui l√≤ng ƒë·ªìng √Ω v·ªõi ƒëi·ªÅu kho·∫£n s·ª≠ d·ª•ng");
            return;
        }

        var checkoutInfo = CartService.CheckoutInfo;
        if (checkoutInfo == null)
        {
            await ToastService.ShowError("Kh√¥ng t√¨m th·∫•y th√¥ng tin ƒë∆°n h√†ng. Vui l√≤ng quay l·∫°i trang checkout.");
            Navigation.NavigateTo("/checkout");
            return;
        }

        IsProcessing = true;
        PaymentStatus = "processing";
        StateHasChanged();

        try
        {
            // 1. T·∫°o ƒë∆°n h√†ng tr∆∞·ªõc
            var orderRequest = new CreateOrderRequest
            {
                UserID = AuthService.IsAuthenticated ? GetUserId() : 0, // C·∫ßn l·∫•y UserID t·ª´ AuthService
                PaymentID = GetPaymentId(SelectedPaymentMethod) ?? 0, // Map payment method to PaymentID
                OrderType = "online",
                Address = $"{checkoutInfo.Address}, {checkoutInfo.City}",
                Note = checkoutInfo.Note,
                OrderDetails = GetOrderDetails(checkoutInfo)
            };

            var createOrderResult = await OrderService.CreateOrderAsync(orderRequest);

            if (!createOrderResult.Success)
            {
                PaymentStatus = "failed";
                IsProcessing = false;
                await ToastService.ShowError(createOrderResult.Message ?? "Kh√¥ng th·ªÉ t·∫°o ƒë∆°n h√†ng");
                StateHasChanged();
                return;
            }

            // L∆∞u OrderID (t·∫°m th·ªùi d√πng timestamp, c·∫ßn l·∫•y t·ª´ API response)
            CreatedOrderId = int.Parse(createOrderResult.Data?.OrderId ?? DateTime.Now.Ticks.ToString().Substring(8));

            // 2. X·ª≠ l√Ω thanh to√°n theo ph∆∞∆°ng th·ª©c ƒë√£ ch·ªçn
            if (SelectedPaymentMethod == "vnpay")
            {
                // T·∫°o URL thanh to√°n VNPay
                var paymentResult = await PaymentService.CreateVNPayPaymentUrlAsync(
                    CreatedOrderId.Value,
                    GetFinalTotalAmount(),
                    $"Thanh toan don hang #{CreatedOrderId}"
                );

                if (paymentResult.Success && !string.IsNullOrEmpty(paymentResult.PaymentUrl))
                {
                    // Redirect ƒë·∫øn VNPay
                    await JSRuntime.InvokeVoidAsync("window.location.href", paymentResult.PaymentUrl);
                    return;
                }
                else
                {
                    PaymentStatus = "failed";
                    IsProcessing = false;
                    await ToastService.ShowError(paymentResult.Message ?? "Kh√¥ng th·ªÉ t·∫°o URL thanh to√°n VNPay");
                    StateHasChanged();
                    return;
                }
            }
            else
            {
                // COD ho·∫∑c c√°c ph∆∞∆°ng th·ª©c kh√°c - ch·ªâ c·∫ßn t·∫°o order
                PaymentStatus = "success";
                IsProcessing = false;
                await ToastService.ShowSuccess("ƒê·∫∑t h√†ng th√†nh c√¥ng! Ch√∫ng t√¥i s·∫Ω li√™n h·ªá v·ªõi b·∫°n s·ªõm nh·∫•t.");
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[Payment] Exception in HandlePayment: {ex.Message}");
            PaymentStatus = "failed";
            IsProcessing = false;
            await ToastService.ShowError($"L·ªói: {ex.Message}");
            StateHasChanged();
        }
    }

    private int GetUserId()
    {
        // TODO: L·∫•y UserID t·ª´ AuthService
        // T·∫°m th·ªùi return 0 ho·∫∑c l·∫•y t·ª´ token
        return 0;
    }

    private int? GetPaymentId(string paymentMethod)
    {
        // Map payment method to PaymentID
        // TODO: L·∫•y t·ª´ database ho·∫∑c config
        return paymentMethod switch
        {
            "cod" => 1, // COD
            "vnpay" => 2, // VNPay
            "momo" => 3, // MoMo
            "banking" => 4, // Banking
            _ => null
        };
    }

    private List<OrderDetailRequest> GetOrderDetails(CheckoutInfo checkoutInfo)
    {
        var orderDetails = new List<OrderDetailRequest>();

        if (checkoutInfo.SelectedApiItems != null && checkoutInfo.SelectedApiItems.Any())
        {
            foreach (var item in checkoutInfo.SelectedApiItems)
            {
                orderDetails.Add(new OrderDetailRequest
                {
                    VariantID = item.VariantID,
                    Quantity = item.Quantity
                });
            }
        }
        else if (checkoutInfo.SelectedLocalItems != null && checkoutInfo.SelectedLocalItems.Any())
        {
            // V·ªõi local items, c·∫ßn t√¨m VariantID t·ª´ Product
            // TODO: C·∫ßn l·∫•y VariantID t·ª´ Product service ho·∫∑c t·ª´ cart item
            // T·∫°m th·ªùi d√πng ProductId l√†m VariantID (c·∫ßn s·ª≠a l·∫°i)
            foreach (var item in checkoutInfo.SelectedLocalItems)
            {
                orderDetails.Add(new OrderDetailRequest
                {
                    VariantID = item.Product.Id, // T·∫°m th·ªùi, c·∫ßn l·∫•y ƒë√∫ng VariantID
                    Quantity = item.Quantity
                });
            }
        }

        return orderDetails;
    }

    private decimal GetFinalTotalAmount()
    {
        decimal total = SubTotal + ShippingFee - Discount;
        if (SelectedPaymentMethod == "cod")
        {
            total += 15000; // COD fee
        }
        return total;
    }

    private string GetFinalTotal()
    {
        return $"{GetFinalTotalAmount():N0}ƒë";
    }

    private async Task CopyToClipboard(string text)
    {
        await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", text);
        await ToastService.ShowSuccess("ƒê√£ sao ch√©p!");
    }
}
