@page "/payment/{OrderId?}"
@using WebUI.Models
@using WebUI.Services
@using WebUI.Services.Interfaces
@inject OrderService OrderService
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject IToastService ToastService
@inject IJSRuntime JSRuntime

<link href="css/ecommerce-theme.css" rel="stylesheet" />
<link href="css/payment-clean.css" rel="stylesheet" />

<div class="payment-page">
    <div class="payment-container">
        <!-- Back Link -->
        <a href="/checkout" class="back-link">
            <i class="fas fa-arrow-left"></i>
            Quay l·∫°i th√¥ng tin giao h√†ng
        </a>

        <div class="payment-header">
            <h1 class="payment-title">Thanh to√°n</h1>
        </div>

        <!-- Progress Steps -->
        <div class="progress-steps">
            <div class="step completed">
                <div class="step-circle"><i class="fas fa-check"></i></div>
                <span class="step-label">Gi·ªè h√†ng</span>
            </div>
            <div class="step-divider active"></div>
            <div class="step completed">
                <div class="step-circle"><i class="fas fa-check"></i></div>
                <span class="step-label">Th√¥ng tin</span>
            </div>
            <div class="step-divider active"></div>
            <div class="step active">
                <div class="step-circle">3</div>
                <span class="step-label">Thanh to√°n</span>
            </div>
        </div>

        @if (IsProcessing)
        {
            <div class="loading-overlay">
                <div class="loading-spinner"></div>
            </div>
        }
        else
        {
            <div class="payment-grid">
                <!-- Left Column - Payment Details -->
                <div class="payment-methods-section">
                    <!-- Shipping Info Card -->
                    <div class="shipping-info-card">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h3 class="info-title">
                                <i class="fas fa-shipping-fast"></i>
                                Th√¥ng tin giao h√†ng
                            </h3>
                            <button class="btn-edit" @onclick='() => Navigation.NavigateTo("/checkout")'>
                                <i class="fas fa-edit"></i> S·ª≠a
                            </button>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Ng∆∞·ªùi nh·∫≠n:</span>
                            <span class="info-value">@ReceiverName</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">S·ªë ƒëi·ªán tho·∫°i:</span>
                            <span class="info-value">@ReceiverPhone</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ƒê·ªãa ch·ªâ:</span>
                            <span class="info-value">@ShippingAddress</span>
                        </div>
                    </div>

                    <!-- Payment Method Selection -->
                    <div class="payment-card">
                        <h2 class="card-title">
                            <i class="fas fa-credit-card card-icon"></i>
                            Ph∆∞∆°ng th·ª©c thanh to√°n
                        </h2>

                        <div class="payment-options">
                            <!-- COD -->
                            <div class="payment-option @(SelectedPaymentMethod == "cod" ? "selected" : "")"
                                 @onclick='() => SelectedPaymentMethod = "cod"'>
                                <div class="payment-radio"></div>
                                <div class="payment-icon-wrapper">üíµ</div>
                                <div class="payment-info">
                                    <div class="payment-method-name">Thanh to√°n khi nh·∫≠n h√†ng (COD)</div>
                                    <div class="payment-method-description">Thanh to√°n b·∫±ng ti·ªÅn m·∫∑t khi nh·∫≠n h√†ng</div>
                                </div>
                                <div class="payment-fee">+15.000ƒë</div>
                            </div>

                            <!-- Banking Transfer -->
                            <div class="payment-option @(SelectedPaymentMethod == "banking" ? "selected" : "")"
                                 @onclick='() => SelectedPaymentMethod = "banking"'>
                                <div class="payment-radio"></div>
                                <div class="payment-icon-wrapper">üè¶</div>
                                <div class="payment-info">
                                    <div class="payment-method-name">Chuy·ªÉn kho·∫£n ng√¢n h√†ng</div>
                                    <div class="payment-method-description">Chuy·ªÉn kho·∫£n qua Internet Banking</div>
                                </div>
                                <div class="payment-fee">Mi·ªÖn ph√≠</div>
                            </div>

                            @if (SelectedPaymentMethod == "banking")
                            {
                                <div class="payment-details">
                                    <div class="bank-info">
                                        <div class="bank-info-row">
                                            <span class="bank-label">Ng√¢n h√†ng:</span>
                                            <span class="bank-value">Vietcombank</span>
                                        </div>
                                        <div class="bank-info-row">
                                            <span class="bank-label">S·ªë t√†i kho·∫£n:</span>
                                            <span class="bank-value">
                                                1234567890
                                                <button class="btn-copy" @onclick='() => CopyToClipboard("1234567890")'>
                                                    Copy
                                                </button>
                                            </span>
                                        </div>
                                        <div class="bank-info-row">
                                            <span class="bank-label">Ch·ªß TK:</span>
                                            <span class="bank-value">C√îNG TY ASION</span>
                                        </div>
                                        <div class="bank-info-row">
                                            <span class="bank-label">N·ªôi dung:</span>
                                            <span class="bank-value">
                                                ORD-@OrderNumber
                                                <button class="btn-copy" @onclick='() => CopyToClipboard($"ORD-{OrderNumber}")'>
                                                    Copy
                                                </button>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            }

                            <!-- Momo -->
                            <div class="payment-option @(SelectedPaymentMethod == "momo" ? "selected" : "")"
                                 @onclick='() => SelectedPaymentMethod = "momo"'>
                                <div class="payment-radio"></div>
                                <div class="payment-icon-wrapper">üì±</div>
                                <div class="payment-info">
                                    <div class="payment-method-name">V√≠ MoMo</div>
                                    <div class="payment-method-description">Qu√©t m√£ QR ƒë·ªÉ thanh to√°n</div>
                                </div>
                                <div class="payment-fee">Mi·ªÖn ph√≠</div>
                            </div>

                            @if (SelectedPaymentMethod == "momo")
                            {
                                <div class="payment-details">
                                    <div class="qr-code-section">
                                        <div class="qr-code-image" style="background: var(--gray-200); display:flex; align-items:center; justify-content:center; color: var(--gray-500);">
                                            QR Code
                                        </div>
                                        <p class="qr-instruction">Qu√©t m√£ QR b·∫±ng ·ª©ng d·ª•ng MoMo</p>
                                    </div>
                                </div>
                            }

                            <!-- ZaloPay -->
                            <div class="payment-option @(SelectedPaymentMethod == "zalopay" ? "selected" : "")"
                                 @onclick='() => SelectedPaymentMethod = "zalopay"'>
                                <div class="payment-radio"></div>
                                <div class="payment-icon-wrapper">üíô</div>
                                <div class="payment-info">
                                    <div class="payment-method-name">ZaloPay</div>
                                    <div class="payment-method-description">Thanh to√°n an to√†n v·ªõi ZaloPay</div>
                                </div>
                                <div class="payment-fee">Mi·ªÖn ph√≠</div>
                            </div>

                            <!-- Credit Card -->
                            <div class="payment-option @(SelectedPaymentMethod == "card" ? "selected" : "")"
                                 @onclick='() => SelectedPaymentMethod = "card"'>
                                <div class="payment-radio"></div>
                                <div class="payment-icon-wrapper">üí≥</div>
                                <div class="payment-info">
                                    <div class="payment-method-name">Th·∫ª t√≠n d·ª•ng/Ghi n·ª£</div>
                                    <div class="payment-method-description">Visa, MasterCard, JCB</div>
                                </div>
                                <div class="payment-fee">Mi·ªÖn ph√≠</div>
                            </div>

                            @if (SelectedPaymentMethod == "card")
                            {
                                <div class="payment-details">
                                    <div class="card-form">
                                        <div class="form-group">
                                            <label class="form-label">S·ªë th·∫ª</label>
                                            <input type="text" class="form-input" placeholder="1234 5678 9012 3456" />
                                        </div>
                                        <div class="card-row">
                                            <div class="form-group">
                                                <label class="form-label">Ng√†y h·∫øt h·∫°n</label>
                                                <input type="text" class="form-input" placeholder="MM/YY" />
                                            </div>
                                            <div class="form-group">
                                                <label class="form-label">CVV</label>
                                                <input type="text" class="form-input" placeholder="123" />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Terms & Conditions -->
                    <div class="terms-section">
                        <input type="checkbox" class="terms-checkbox" @bind="AgreeTerms" id="agreeTerms" />
                        <label for="agreeTerms" class="terms-text">
                            T√¥i ƒë·ªìng √Ω v·ªõi <a href="#" class="terms-link">ƒêi·ªÅu kho·∫£n & ƒêi·ªÅu ki·ªán</a> c·ªßa Asion
                        </label>
                    </div>
                </div>

                <!-- Right Column - Order Summary -->
                <div class="order-summary-sidebar">
                    <div class="summary-card">
                        <h3 class="summary-header">T√≥m t·∫Øt ƒë∆°n h√†ng</h3>

                        <div class="summary-divider"></div>

                        <!-- Price Breakdown -->
                        <div class="summary-row">
                            <span class="summary-label">T·∫°m t√≠nh</span>
                            <span class="summary-value">@SubTotal.ToString("N0")ƒë</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Ph√≠ v·∫≠n chuy·ªÉn</span>
                            <span class="summary-value">@ShippingFee.ToString("N0")ƒë</span>
                        </div>
                        @if (SelectedPaymentMethod == "cod")
                        {
                            <div class="summary-row">
                                <span class="summary-label">Ph√≠ thu h·ªô COD</span>
                                <span class="summary-value">15.000ƒë</span>
                            </div>
                        }
                        @if (Discount > 0)
                        {
                            <div class="summary-row discount">
                                <span class="summary-label">Gi·∫£m gi√°</span>
                                <span class="summary-value">-@Discount.ToString("N0")ƒë</span>
                            </div>
                        }
                        <div class="summary-divider"></div>
                        <div class="summary-row total">
                            <span class="summary-label">T·ªïng c·ªông</span>
                            <span class="summary-value">@GetFinalTotal()</span>
                        </div>

                        <!-- Action Buttons -->
                        <button class="btn-confirm-payment" 
                                @onclick="HandlePayment"
                                disabled="@(!AgreeTerms || IsProcessing)">
                            @if (IsProcessing)
                            {
                                <div class="loading-spinner"></div>
                                <span>ƒêang x·ª≠ l√Ω...</span>
                            }
                            else
                            {
                                <i class="fas fa-lock"></i>
                                <span>X√°c nh·∫≠n thanh to√°n</span>
                            }
                        </button>

                        <div class="security-badge">
                            <i class="fas fa-shield-alt security-icon"></i>
                            <span>Giao d·ªãch b·∫£o m·∫≠t SSL</span>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@code {
    [Parameter]
    public string? OrderId { get; set; }

    private string OrderNumber = DateTime.Now.Ticks.ToString().Substring(8);
    private string ReceiverName = "Nguy·ªÖn VƒÉn A";
    private string ReceiverPhone = "0912345678";
    private string ShippingAddress = "123 Nguy·ªÖn Hu·ªá, Qu·∫≠n 1, TP. H·ªì Ch√≠ Minh";
    
    private string SelectedPaymentMethod = "cod";
    private bool AgreeTerms = false;
    private bool IsProcessing = false;
    
    private decimal SubTotal = 3290000;
    private decimal ShippingFee = 50000;
    private decimal Discount = 0;

    private async Task HandlePayment()
    {
        if (!AgreeTerms)
        {
            await ToastService.ShowError("Vui l√≤ng ƒë·ªìng √Ω v·ªõi ƒëi·ªÅu kho·∫£n s·ª≠ d·ª•ng");
            return;
        }

        IsProcessing = true;
        StateHasChanged();

        await Task.Delay(2000); // Simulate payment processing

        await ToastService.ShowSuccess("Thanh to√°n th√†nh c√¥ng!");
        Navigation.NavigateTo($"/order-success/{OrderNumber}");
    }

    private string GetFinalTotal()
    {
        decimal total = SubTotal + ShippingFee - Discount;
        if (SelectedPaymentMethod == "cod")
        {
            total += 15000; // COD fee
        }
        return $"{total:N0}ƒë";
    }

    private async Task CopyToClipboard(string text)
    {
        await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", text);
        await ToastService.ShowSuccess("ƒê√£ sao ch√©p!");
    }
}
