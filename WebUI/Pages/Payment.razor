@page "/payment/{OrderId?}"
@using WebUI.Models
@using WebUI.Services
@using WebUI.Services.Interfaces
@inject OrderService OrderService
@inject IPaymentService PaymentService
@inject CartService CartService
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject IToastService ToastService
@inject IJSRuntime JSRuntime

@* Unified minimal theme styles are in asion.css *@

<div class="payment-page">
    <div class="payment-container">
        <!-- Back Link -->
        <a href="/checkout" class="back-link">
            <i class="fas fa-arrow-left"></i>
            Quay l·∫°i th√¥ng tin giao h√†ng
        </a>

        <div class="payment-header">
            <h1 class="payment-title">Thanh to√°n</h1>
        </div>

        <!-- Progress Steps -->
        @if (IsProcessing)
        {
            <div class="payment-status processing">
                <div class="payment-status-icon">
                    <i class="fas fa-spinner"></i>
                </div>
                <h2 class="payment-status-title">ƒêang x·ª≠ l√Ω thanh to√°n...</h2>
                <p class="payment-status-message">Vui l√≤ng ƒë·ª£i trong gi√¢y l√°t</p>
            </div>
        }
        else if (PaymentStatus == "success")
        {
            <div class="payment-status success">
                <div class="payment-status-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h2 class="payment-status-title">Thanh to√°n th√†nh c√¥ng!</h2>
                <p class="payment-status-message">ƒê∆°n h√†ng c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n</p>
                <button class="btn-complete" @onclick='() => Navigation.NavigateTo("/")'>
                    <i class="fas fa-home"></i>
                    Tr·ªü v·ªÅ trang ch·ªß
                </button>
            </div>
        }
        else if (PaymentStatus == "failed")
        {
            <div class="payment-status failed">
                <div class="payment-status-icon">
                    <i class="fas fa-times-circle"></i>
                </div>
                <h2 class="payment-status-title">Thanh to√°n th·∫•t b·∫°i</h2>
                <p class="payment-status-message">Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n kh√°c</p>
                <button class="btn-continue" @onclick='() => PaymentStatus = ""'>
                    <i class="fas fa-redo"></i>
                    Th·ª≠ l·∫°i
                </button>
            </div>
    }
    else
        {
            <div style="display: flex; flex-direction: column; gap: 24px; max-width: 800px; margin: 0 auto;">
                <!-- Payment Details -->
                <div class="payment-methods-section">
                    <!-- Shipping Info Card -->
                    <div class="shipping-info-card">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h3 class="info-title">
                                <i class="fas fa-shipping-fast"></i>
                                Th√¥ng tin giao h√†ng
                            </h3>
                            <button class="btn-edit" @onclick='() => Navigation.NavigateTo("/checkout")'>
                                <i class="fas fa-edit"></i> S·ª≠a
                            </button>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Ng∆∞·ªùi nh·∫≠n:</span>
                            <span class="info-value">@ReceiverName</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">S·ªë ƒëi·ªán tho·∫°i:</span>
                            <span class="info-value">@ReceiverPhone</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ƒê·ªãa ch·ªâ:</span>
                            <span class="info-value">@ShippingAddress</span>
                        </div>
                    </div>

                    <!-- Payment Method Selection -->
                    <div class="payment-card">
                        <h2 class="card-title">
                            <i class="fas fa-credit-card card-icon"></i>
                            Ph∆∞∆°ng th·ª©c thanh to√°n
                        </h2>

                        <div class="payment-options">
                            <!-- COD -->
                            <div class="payment-option @(SelectedPaymentMethod == "cod" ? "selected" : "")"
                                 @onclick='() => SelectedPaymentMethod = "cod"'>
                                <div class="payment-radio"></div>
                                <div class="payment-icon-wrapper">üíµ</div>
                                <div class="payment-info">
                                    <div class="payment-method-name">Thanh to√°n khi nh·∫≠n h√†ng (COD)</div>
                                    <div class="payment-method-description">Thanh to√°n b·∫±ng ti·ªÅn m·∫∑t khi nh·∫≠n h√†ng</div>
                                </div>
                                <div class="payment-fee">+15.000ƒë</div>
                            </div>

                            <!-- Banking Transfer -->
                            <div class="payment-option @(SelectedPaymentMethod == "banking" ? "selected" : "")"
                                 @onclick='() => SelectedPaymentMethod = "banking"'>
                                <div class="payment-radio"></div>
                                <div class="payment-icon-wrapper">üè¶</div>
                                <div class="payment-info">
                                    <div class="payment-method-name">Chuy·ªÉn kho·∫£n ng√¢n h√†ng</div>
                                    <div class="payment-method-description">Chuy·ªÉn kho·∫£n qua Internet Banking</div>
                                </div>
                                <div class="payment-fee">Mi·ªÖn ph√≠</div>
                            </div>
                            @if (SelectedPaymentMethod == "banking")
                            {
                                <div class="payment-details">
                                    <div class="bank-info">
                                        <div class="bank-info-row">
                                            <span class="bank-label">Ng√¢n h√†ng:</span>
                                            <span class="bank-value">Vietcombank</span>
                                        </div>
                                        <div class="bank-info-row">
                                            <span class="bank-label">S·ªë t√†i kho·∫£n:</span>
                                            <span class="bank-value">
                                                1234567890
                                                <button class="btn-copy" @onclick='() => CopyToClipboard("1234567890")'>
                                                    Copy
                                                </button>
                                            </span>
                                        </div>
                                        <div class="bank-info-row">
                                            <span class="bank-label">Ch·ªß TK:</span>
                                            <span class="bank-value">C√îNG TY ASION</span>
                                        </div>
                                        <div class="bank-info-row">
                                            <span class="bank-label">N·ªôi dung:</span>
                                            <span class="bank-value">
                                                ORD-@OrderNumber
                                                <button class="btn-copy" @onclick='() => CopyToClipboard($"ORD-{OrderNumber}")'>
                                                    Copy
                                                </button>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            }

                            <!-- Momo -->
                            <div class="payment-option @(SelectedPaymentMethod == "momo" ? "selected" : "")"
                                 @onclick='() => SelectedPaymentMethod = "momo"'>
                                <div class="payment-radio"></div>
                                <div class="payment-icon-wrapper">üì±</div>
                                <div class="payment-info">
                                    <div class="payment-method-name">V√≠ MoMo</div>
                                    <div class="payment-method-description">Qu√©t m√£ QR ƒë·ªÉ thanh to√°n</div>
                                </div>
                                <div class="payment-fee">Mi·ªÖn ph√≠</div>
                            </div>
                            @if (SelectedPaymentMethod == "momo")
                            {
                                <div class="payment-details">
                                    <div class="qr-code-section">
                                        <div class="qr-code-image" style="background: var(--gray-200); display:flex; align-items:center; justify-content:center; color: var(--gray-500);">
                                            QR Code
                                        </div>
                                        <p class="qr-instruction">Qu√©t m√£ QR b·∫±ng ·ª©ng d·ª•ng MoMo</p>
                                    </div>
                                </div>
                            }

                            <!-- ZaloPay -->
                            <div class="payment-option @(SelectedPaymentMethod == "zalopay" ? "selected" : "")"
                                 @onclick='() => SelectedPaymentMethod = "zalopay"'>
                                <div class="payment-radio"></div>
                                <div class="payment-icon-wrapper">üíô</div>
                                <div class="payment-info">
                                    <div class="payment-method-name">ZaloPay</div>
                                    <div class="payment-method-description">Thanh to√°n an to√†n v·ªõi ZaloPay</div>
                                </div>
                                <div class="payment-fee">Mi·ªÖn ph√≠</div>
                            </div>

                            <!-- Credit Card -->
                            <div class="payment-option @(SelectedPaymentMethod == "card" ? "selected" : "")"
                                 @onclick='() => SelectedPaymentMethod = "card"'>
                                <div class="payment-radio"></div>
                                <div class="payment-icon-wrapper">üí≥</div>
                                <div class="payment-info">
                                    <div class="payment-method-name">Th·∫ª t√≠n d·ª•ng/Ghi n·ª£</div>
                                    <div class="payment-method-description">Visa, MasterCard, JCB</div>
                                </div>
                                <div class="payment-fee">Mi·ªÖn ph√≠</div>
                            </div>
                            @if (SelectedPaymentMethod == "card")
                            {
                                <div class="payment-details">
                                    <div class="card-form">
                                        <div class="form-group">
                                            <label class="form-label">S·ªë th·∫ª</label>
                                            <input type="text" class="form-input" placeholder="1234 5678 9012 3456" />
                                        </div>
                                        <div class="card-row">
                                            <div class="form-group">
                                                <label class="form-label">Ng√†y h·∫øt h·∫°n</label>
                                                <input type="text" class="form-input" placeholder="MM/YY" />
                                            </div>
                                            <div class="form-group">
                                                <label class="form-label">CVV</label>
                                                <input type="text" class="form-input" placeholder="123" />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }

                            <!-- VNPay -->
                            <div class="payment-option @(SelectedPaymentMethod == "vnpay" ? "selected" : "")"
                                 @onclick='() => SelectedPaymentMethod = "vnpay"'>
                                <div class="payment-radio"></div>
                                <div class="payment-icon-wrapper">üåê</div>
                                <div class="payment-info">
                                    <div class="payment-method-name">Thanh to√°n qua VNPay</div>
                                    <div class="payment-method-description">Thanh to√°n online qua c·ªïng VNPay</div>
                                </div>
                                <div class="payment-fee">Mi·ªÖn ph√≠</div>
                            </div>

                            <!-- Google Pay -->
                            <div class="payment-option @(SelectedPaymentMethod == "gpay" ? "selected" : "")"
                                 @onclick='() => SelectedPaymentMethod = "gpay"'>
                                <div class="payment-radio"></div>
                                <div class="payment-icon-wrapper">üì≤</div>
                                <div class="payment-info">
                                    <div class="payment-method-name">Google Pay</div>
                                    <div class="payment-method-description">Thanh to√°n nhanh ch√≥ng v·ªõi Google Pay</div>
                                </div>
                                <div class="payment-fee">Mi·ªÖn ph√≠</div>
                            </div>
                            @* Kh√¥ng c·∫ßn n√∫t ri√™ng cho Google Pay, s·∫Ω g·ªçi t·ª± ƒë·ªông khi nh·∫•n Thanh to√°n *@
@code {
    // ...existing code...

    private async Task ShowGooglePay()
    {
        // Nh√∫ng Google Pay JS SDK qua JSInterop
        var amount = GetFinalTotalAmount();
        await JSRuntime.InvokeVoidAsync("eval", $@"
            (function() {{
                if (!window.google || !window.google.payments) {{
                    alert('Google Pay SDK ch∆∞a s·∫µn s√†ng!');
                    return;
                }}
                var paymentsClient = new google.payments.api.PaymentsClient({{ environment: 'TEST' }});
                var baseRequest = {{ apiVersion: 2, apiVersionMinor: 0 }};
                var allowedCardNetworks = ['VISA', 'MASTERCARD'];
                var allowedAuthMethods = ['PAN_ONLY', 'CRYPTOGRAM_3DS'];
                var tokenizationSpec = {{
                    type: 'PAYMENT_GATEWAY',
                    parameters: {{
                        gateway: 'stripe',
                        'stripe:version': '2020-08-27',
                        'stripe:publishableKey': 'pk_test_51SSDaCQvdo5RfVd5QXPLYoKsDjU0UuUo3qgvNBuPptjgUm9f8x43P636jLPVD1wWXPTX4pUYKy3rMawui9EsDSgV00hfGDVemy'
                    }}
                }};
                var cardPaymentMethod = {{
                    type: 'CARD',
                    parameters: {{
                        allowedAuthMethods: allowedAuthMethods,
                        allowedCardNetworks: allowedCardNetworks,
                        billingAddressRequired: true,
                        billingAddressParameters: {{ format: 'FULL' }}
                    }},
                    tokenizationSpecification: tokenizationSpec
                }};
                var paymentDataRequest = {{
                    apiVersion: 2,
                    apiVersionMinor: 0,
                    allowedPaymentMethods: [cardPaymentMethod],
                    transactionInfo: {{
                        totalPriceStatus: 'FINAL',
                        totalPrice: '{amount}',
                        currencyCode: 'USD',
                        countryCode: 'US'
                    }},
                    merchantInfo: {{ merchantName: 'Asion Store' }}
                }};
                paymentsClient.loadPaymentData(paymentDataRequest)
                    .then(function(paymentData) {{
                        var token = paymentData.paymentMethodData.tokenizationData.token;
                        if (window.DotNet && window.DotNet.invokeMethodAsync) {{
                            window.DotNet.invokeMethodAsync('WebUI', 'ReceiveGPayToken', token);
                        }}
                    }})
                    .catch(function(err) {{
                        alert('‚ùå L·ªói Google Pay: ' + err);
                    }});
            }})();
        ");
    }
}

                        </div>
                    </div>

                </div>

                <!-- Order Summary -->
                <div class="summary-card" style="max-width: 100%;">
                    <h3 class="summary-header">T√≥m t·∫Øt ƒë∆°n h√†ng</h3>
                    <div class="summary-divider"></div>
                    <div class="summary-row">
                        <span class="summary-label">T·∫°m t√≠nh</span>
                        <span class="summary-value">@SubTotal.ToString("N0")ƒë</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Ph√≠ v·∫≠n chuy·ªÉn</span>
                        <span class="summary-value">@ShippingFee.ToString("N0")ƒë</span>
                    </div>
                    @if (SelectedPaymentMethod == "cod")
                    {
                        <div class="summary-row">
                            <span class="summary-label">Ph√≠ thu h·ªô COD</span>
                            <span class="summary-value">15.000ƒë</span>
                        </div>
                    }
                    @if (Discount > 0)
                    {
                        <div class="summary-row discount">
                            <span class="summary-label">Gi·∫£m gi√°</span>
                            <span class="summary-value">-@Discount.ToString("N0")ƒë</span>
                        </div>
                    }
                    <div class="summary-divider"></div>
                    <div class="summary-row total">
                        <span class="summary-label">T·ªïng c·ªông</span>
                        <span class="summary-value">@GetFinalTotal()</span>
                    </div>
                    <div class="terms-section">
                        <input type="checkbox" class="terms-checkbox" @bind="AgreeTerms" id="agreeTerms" />
                        <label for="agreeTerms" class="terms-text">
                            T√¥i ƒë·ªìng √Ω v·ªõi <a href="#" class="terms-link">ƒêi·ªÅu kho·∫£n & ƒêi·ªÅu ki·ªán</a> c·ªßa Asion
                        </label>
                    </div>
                    <div class="payment-actions">
                        <button class="btn btn-primary" @onclick="OnPayClicked">Thanh to√°n</button>
                    </div>
                    <div class="security-badge">
                        <i class="fas fa-shield-alt security-icon"></i>
                        <span>Giao d·ªãch b·∫£o m·∫≠t SSL</span>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@code {
    [Parameter]
    public string? OrderId { get; set; }

    private string OrderNumber = DateTime.Now.Ticks.ToString().Substring(8);
    private string ReceiverName = string.Empty;
    private string ReceiverPhone = string.Empty;
    private string ShippingAddress = string.Empty;
    
    private string SelectedPaymentMethod = "cod";
    private bool AgreeTerms = false;
    private bool IsProcessing = false;
    private string PaymentStatus = ""; // "", "processing", "success", "failed"
    private int? CreatedOrderId;
    private decimal SubTotal => CartService.CheckoutInfo?.Subtotal ?? 0;
    private decimal ShippingFee => CartService.CheckoutInfo?.ShippingFee ?? 0;
    private decimal Discount => 0;

    protected override void OnInitialized()
    {
        // L·∫•y th√¥ng tin t·ª´ Checkout
        var checkoutInfo = CartService.CheckoutInfo;
        if (checkoutInfo == null)
        {
            // N·∫øu kh√¥ng c√≥ th√¥ng tin checkout, quay l·∫°i trang checkout
            Navigation.NavigateTo("/checkout");
            return;
        }

        ReceiverName = checkoutInfo.FullName;
        ReceiverPhone = checkoutInfo.Phone;
        ShippingAddress = $"{checkoutInfo.Address}, {checkoutInfo.City}";
    }

    private async Task HandlePayment()
    {
        if (!AgreeTerms)
        {
            await ToastService.ShowError("Vui l√≤ng ƒë·ªìng √Ω v·ªõi ƒëi·ªÅu kho·∫£n s·ª≠ d·ª•ng");
            return;
        }

        var checkoutInfo = CartService.CheckoutInfo;
        if (checkoutInfo == null)
        {
            await ToastService.ShowError("Kh√¥ng t√¨m th·∫•y th√¥ng tin ƒë∆°n h√†ng. Vui l√≤ng quay l·∫°i trang checkout.");
            Navigation.NavigateTo("/checkout");
            return;
        }

        IsProcessing = true;
        PaymentStatus = "processing";
        StateHasChanged();

        try
        {
            // 1. T·∫°o ƒë∆°n h√†ng tr∆∞·ªõc
            var orderRequest = new CreateOrderRequest
            {
                UserID = AuthService.IsAuthenticated ? GetUserId() : 0,
                PaymentID = GetPaymentId(SelectedPaymentMethod) ?? 0, // Map payment method to PaymentID
                OrderType = "online",
                Address = $"{checkoutInfo.Address}, {checkoutInfo.City}",
                Note = checkoutInfo.Note,
                OrderDetails = GetOrderDetails(checkoutInfo)
            };

            var createOrderResult = await OrderService.CreateOrderAsync(orderRequest);

            if (!createOrderResult.Success)
            {
                PaymentStatus = "failed";
                IsProcessing = false;
                await ToastService.ShowError(createOrderResult.Message ?? "Kh√¥ng th·ªÉ t·∫°o ƒë∆°n h√†ng");
                StateHasChanged();
                return;
            }

            // L∆∞u OrderID (t·∫°m th·ªùi d√πng timestamp, c·∫ßn l·∫•y t·ª´ API response)
            CreatedOrderId = createOrderResult.Data;

            // 2. X·ª≠ l√Ω thanh to√°n theo ph∆∞∆°ng th·ª©c ƒë√£ ch·ªçn
            if (SelectedPaymentMethod == "vnpay")
            {
                // T·∫°o URL thanh to√°n VNPay
                var paymentResult = await PaymentService.CreateVNPayPaymentUrlAsync(
                    CreatedOrderId.Value,
                    GetFinalTotalAmount(),
                    $"Thanh toan don hang #{CreatedOrderId}"
                );

                if (paymentResult.Success && !string.IsNullOrEmpty(paymentResult.PaymentUrl))
                {
                    // Redirect ƒë·∫øn VNPay
                    await JSRuntime.InvokeVoidAsync("open", paymentResult.PaymentUrl, "_self");
                    return;
                }
                else
                {
                    PaymentStatus = "failed";
                    IsProcessing = false;
                    await ToastService.ShowError(paymentResult.Message ?? "Kh√¥ng th·ªÉ t·∫°o URL thanh to√°n VNPay");
                    StateHasChanged();
                    return;
                }
            }
            else
            {
                // COD ho·∫∑c c√°c ph∆∞∆°ng th·ª©c kh√°c - ch·ªâ c·∫ßn t·∫°o order
                PaymentStatus = "success";
                IsProcessing = false;
                await ToastService.ShowSuccess("ƒê·∫∑t h√†ng th√†nh c√¥ng! Ch√∫ng t√¥i s·∫Ω li√™n h·ªá v·ªõi b·∫°n s·ªõm nh·∫•t.");
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[Payment] Exception in HandlePayment: {ex.Message}");
            PaymentStatus = "failed";
            IsProcessing = false;
            await ToastService.ShowError($"L·ªói: {ex.Message}");
            StateHasChanged();
        }
    }

    private int GetUserId()
    {
        // TODO: L·∫•y UserID t·ª´ AuthService
        // T·∫°m th·ªùi return 0 ho·∫∑c l·∫•y t·ª´ token
        return 0;
    }

    private int? GetPaymentId(string paymentMethod)
    {
        // Map payment method to PaymentID
        // TODO: L·∫•y t·ª´ database ho·∫∑c config
        return paymentMethod switch
        {
            "cod" => 1, // COD
            "vnpay" => 2, // VNPay
            "momo" => 3, // MoMo
            "banking" => 4, // Banking
            _ => null
        };
    }

    private List<OrderDetailRequest> GetOrderDetails(CheckoutInfo checkoutInfo)
    {
        var orderDetails = new List<OrderDetailRequest>();

        if (checkoutInfo.SelectedApiItems != null && checkoutInfo.SelectedApiItems.Any())
        {
            foreach (var item in checkoutInfo.SelectedApiItems)
            {
                orderDetails.Add(new OrderDetailRequest
                {
                    VariantID = item.VariantID,
                    Quantity = item.Quantity
                });
            }
        }
        else if (checkoutInfo.SelectedLocalItems != null && checkoutInfo.SelectedLocalItems.Any())
        {
            // V·ªõi local items, c·∫ßn t√¨m VariantID t·ª´ Product
            // TODO: C·∫ßn l·∫•y VariantID t·ª´ Product service ho·∫∑c t·ª´ cart item
            // T·∫°m th·ªùi d√πng ProductId l√†m VariantID (c·∫ßn s·ª≠a l·∫°i)
            foreach (var item in checkoutInfo.SelectedLocalItems)
            {
                orderDetails.Add(new OrderDetailRequest
                {
                    VariantID = item.Product.Id, // T·∫°m th·ªùi, c·∫ßn l·∫•y ƒë√∫ng VariantID
                    Quantity = item.Quantity
                });
            }
        }

        return orderDetails;
    }

    private decimal GetFinalTotalAmount()
    {
        decimal total = SubTotal + ShippingFee - Discount;
        if (SelectedPaymentMethod == "cod")
        {
            total += 15000; // COD fee
        }
        return total;
    }

    private string GetFinalTotal()
    {
        return $"{GetFinalTotalAmount():N0}ƒë";
    }

    private async Task CopyToClipboard(string text)
    {
        await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", text);
        await ToastService.ShowSuccess("ƒê√£ sao ch√©p!");
    }

    private async Task HandleVNPayPayment()
    {
        IsProcessing = true;
        PaymentStatus = "";
        StateHasChanged();
        try
        {
            // T·∫°o order tr∆∞·ªõc (n·∫øu ch∆∞a c√≥)
            if (CreatedOrderId == null)
            {
                var orderRequest = new CreateOrderRequest
                {
                    UserID = GetUserId(),
                    Address = CartService.CheckoutInfo?.Address ?? "",
                    Note = CartService.CheckoutInfo?.Note ?? "",
                    PaymentID = GetPaymentId("vnpay") ?? 2,
                    OrderDetails = GetOrderDetails(CartService.CheckoutInfo!)
                };
                var orderResult = await OrderService.CreateOrderAsync(orderRequest);
                if (orderResult.Success)
                {
                    CreatedOrderId = Convert.ToInt32(orderResult.Data);
                }
                else
                {
                    PaymentStatus = "failed";
                    IsProcessing = false;
                    await ToastService.ShowError(orderResult.Message ?? "Kh√¥ng th·ªÉ t·∫°o ƒë∆°n h√†ng");
                    StateHasChanged();
                    return;
                }
            }
            // N·∫øu ƒë√£ c√≥ OrderId, m·ªõi g·ªçi VNPay
            if (CreatedOrderId > 0)
            {
                var response = await PaymentService.CreateVNPayPaymentUrlAsync(CreatedOrderId.Value, GetFinalTotalAmount(), $"Thanh toan don hang #{CreatedOrderId}");
                if (response != null && !string.IsNullOrEmpty(response.PaymentUrl))
                {
                    // Redirect ƒë·∫øn VNPay
                    await JSRuntime.InvokeVoidAsync("open", response.PaymentUrl, "_self");
                    return;
                }
                else
                {
                    PaymentStatus = "failed";
                    IsProcessing = false;
                    await ToastService.ShowError(response?.Message ?? "Kh√¥ng th·ªÉ t·∫°o URL thanh to√°n VNPay");
                    StateHasChanged();
                    return;
                }
            }
        }
        catch (Exception ex)
        {
            PaymentStatus = "failed";
            IsProcessing = false;
            await ToastService.ShowError($"L·ªói: {ex.Message}");
            StateHasChanged();
        }
    }

    private async Task HandleCODPayment()
    {
        IsProcessing = true;
        PaymentStatus = "";
        StateHasChanged();
        try
        {
            // T·∫°o order v·ªõi ph∆∞∆°ng th·ª©c COD
            var orderRequest = new CreateOrderRequest
            {
                UserID = GetUserId(),
                Address = CartService.CheckoutInfo?.Address ?? "",
                Note = CartService.CheckoutInfo?.Note ?? "",
                PaymentID = GetPaymentId("cod") ?? 1,
                OrderDetails = GetOrderDetails(CartService.CheckoutInfo!)
            };
            var orderResult = await OrderService.CreateOrderAsync(orderRequest);
            if (orderResult.Success)
            {
                PaymentStatus = "success";
                IsProcessing = false;
                await ToastService.ShowSuccess("ƒê·∫∑t h√†ng th√†nh c√¥ng! Ch√∫ng t√¥i s·∫Ω li√™n h·ªá v·ªõi b·∫°n s·ªõm nh·∫•t.");
                StateHasChanged();
            }
            else
            {
                PaymentStatus = "failed";
                IsProcessing = false;
                await ToastService.ShowError(orderResult.Message ?? "Kh√¥ng th·ªÉ t·∫°o ƒë∆°n h√†ng");
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            PaymentStatus = "failed";
            IsProcessing = false;
            await ToastService.ShowError($"L·ªói: {ex.Message}");
            StateHasChanged();
        }
    }


    // Removed unused GPay fields

    private async Task OnPayClicked()
    {
        if (SelectedPaymentMethod == "vnpay")
        {
            await HandleVNPayPayment();
        }
        else if (SelectedPaymentMethod == "cod")
        {
            await HandleCODPayment();
        }
        else if (SelectedPaymentMethod == "gpay")
        {
            IsProcessing = true;
            PaymentStatus = "processing";
            StateHasChanged();
            // 1. T·∫°o ƒë∆°n h√†ng tr∆∞·ªõc khi g·ªçi Google Pay
            var orderRequest = new CreateOrderRequest
            {
                UserID = GetUserId(),
                Address = CartService.CheckoutInfo?.Address ?? "",
                Note = CartService.CheckoutInfo?.Note ?? "",
                PaymentID = GetPaymentId("gpay") ?? 0,
                OrderDetails = GetOrderDetails(CartService.CheckoutInfo!)
            };
            var orderResult = await OrderService.CreateOrderAsync(orderRequest);
            if (!orderResult.Success || orderResult.Data == null)
            {
                PaymentStatus = "failed";
                IsProcessing = false;
                await ToastService.ShowError(orderResult.Message ?? "Kh√¥ng th·ªÉ t·∫°o ƒë∆°n h√†ng");
                StateHasChanged();
                return;
            }
            var createdOrderId = Convert.ToInt32(orderResult.Data);
            var amount = GetFinalTotalAmount();
            // L∆∞u orderId v√† amount (VND) v√†o localStorage
            await JSRuntime.InvokeVoidAsync("eval", $"localStorage.setItem('gpay_orderId', '{createdOrderId}')");
            await JSRuntime.InvokeVoidAsync("eval", $"localStorage.setItem('gpay_amount', '{amount:F0}')");
            // 2. G·ªçi Google Pay SDK qua JSInterop ƒë·ªÉ l·∫•y token v√† x·ª≠ l√Ω lu√¥n
            await JSRuntime.InvokeVoidAsync("eval", $@"
                (function() {{
                    if (!window.google || !window.google.payments) {{
                        alert('Google Pay SDK ch∆∞a s·∫µn s√†ng!');
                        return;
                    }}
                    var paymentsClient = new google.payments.api.PaymentsClient({{ environment: 'TEST' }});
                    var baseRequest = {{ apiVersion: 2, apiVersionMinor: 0 }};
                    var allowedCardNetworks = ['VISA', 'MASTERCARD'];
                    var allowedAuthMethods = ['PAN_ONLY', 'CRYPTOGRAM_3DS'];
                    var tokenizationSpec = {{
                        type: 'PAYMENT_GATEWAY',
                        parameters: {{
                            gateway: 'stripe',
                            'stripe:version': '2020-08-27',
                            'stripe:publishableKey': 'pk_test_51SSDaCQvdo5RfVd5QXPLYoKsDjU0UuUo3qgvNBuPptjgUm9f8x43P636jLPVD1wWXPTX4pUYKy3rMawui9EsDSgV00hfGDVemy'
                        }}
                    }};
                    var cardPaymentMethod = {{
                        type: 'CARD',
                        parameters: {{
                            allowedAuthMethods: allowedAuthMethods,
                            allowedCardNetworks: allowedCardNetworks,
                            billingAddressRequired: true,
                            billingAddressParameters: {{ format: 'FULL' }}
                        }},
                        tokenizationSpecification: tokenizationSpec
                    }};
                    var paymentDataRequest = {{
                        apiVersion: 2,
                        apiVersionMinor: 0,
                        allowedPaymentMethods: [cardPaymentMethod],
                        transactionInfo: {{
                            totalPriceStatus: 'FINAL',
                            totalPrice: '{amount}',
                            currencyCode: 'VND',
                            countryCode: 'VN'
                        }},
                        merchantInfo: {{ merchantName: 'Asion Store' }}
                    }};
                    paymentsClient.loadPaymentData(paymentDataRequest)
                        .then(function(paymentData) {{
                            var token = paymentData.paymentMethodData.tokenizationData.token;
                            if (window.DotNet && window.DotNet.invokeMethodAsync) {{
                                window.DotNet.invokeMethodAsync('WebUI', 'ReceiveGPayToken', token);
                            }}
                        }})
                        .catch(function(err) {{
                            alert('‚ùå L·ªói Google Pay: ' + err);
                        }});
                }})();
            ");
        }
    }

    // Khi nh·∫≠n token t·ª´ JS, th·ª±c hi·ªán thanh to√°n lu√¥n
    [JSInvokable]
    public static async Task ReceiveGPayToken(string token)
    {
        var serviceProvider = Program.ServiceProvider;
        if (serviceProvider == null)
        {
            return;
        }
        var nav = serviceProvider.GetService(typeof(NavigationManager)) as NavigationManager;
        var paymentService = serviceProvider.GetService(typeof(IPaymentService)) as IPaymentService;
        if (nav == null || paymentService == null)
        {
            return;
        }
        var navSafe = nav!;
        var paymentServiceSafe = paymentService!;
        // ƒê·ªçc amount v√† orderId t·ª´ localStorage qua JSInterop
        var jsRuntime = serviceProvider.GetService(typeof(IJSRuntime)) as IJSRuntime;
        if (jsRuntime == null)
        {
            return;
        }
        // ƒê·ªçc gi√° tr·ªã t·ª´ localStorage
        var amountStr = await jsRuntime.InvokeAsync<string>("eval", "localStorage.getItem('gpay_amount')");
        var orderIdStr = await jsRuntime.InvokeAsync<string>("eval", "localStorage.getItem('gpay_orderId')");
        long amount = 0;
        int orderId = 0;
        long.TryParse(amountStr, out amount);
        int.TryParse(orderIdStr, out orderId);
        // Stripe expects amount in VND (not cents)
        if (amount < 1000 || amount > 99999999)
        {
            // Handle error: amount must be >= 1000 VND and <= 99,999,999 VND
            return;
        }
        var gpayRequest = new PaymentGPayRequest
        {
            Token = token,
            Amount = amount,
            Currency = "vnd",
            Description = $"Thanh to√°n ƒë∆°n h√†ng #{orderId} qua Google Pay"
        };
        var gpayResult = await paymentServiceSafe.CreateGPayPaymentAsync(gpayRequest);
        if (gpayResult != null && gpayResult.Success && !string.IsNullOrEmpty(gpayResult.TransactionId))
        {
            navSafe.NavigateTo($"/payment-success?transactionId={gpayResult.TransactionId}&amount={gpayRequest.Amount}");
        }
    }


}

