@page "/checkout"
@using WebUI.Models
@using WebUI.Models.Cart
@using WebUI.Services
@using WebUI.Services.Interfaces
@inject CartService CartService
@inject IAuthService AuthService
@inject OrderService OrderService
@inject NavigationManager Navigation
@inject IToastService ToastService
@inject ILoadingService LoadingService

<link href="css/ecommerce-theme.css" rel="stylesheet" />
<link href="css/checkout-clean.css" rel="stylesheet" />

<div class="checkout-page">
    <div class="checkout-container">
        <!-- Breadcrumb & Back Link -->
        <a href="/cart" class="back-link">
            <i class="fas fa-arrow-left"></i>
            Quay l·∫°i gi·ªè h√†ng
        </a>

        <div class="checkout-header">
            <h1 class="checkout-title">Thanh to√°n</h1>
        </div>

        <!-- Progress Steps -->
        <div class="progress-steps">
            <div class="step completed">
                <div class="step-circle"><i class="fas fa-check"></i></div>
                <span class="step-label">Gi·ªè h√†ng</span>
            </div>
            <div class="step-divider active"></div>
            <div class="step active">
                <div class="step-circle">2</div>
                <span class="step-label">Th√¥ng tin</span>
            </div>
            <div class="step-divider"></div>
            <div class="step">
                <div class="step-circle">3</div>
                <span class="step-label">Thanh to√°n</span>
            </div>
        </div>

        @if (!HasCartItems())
        {
            <div style="text-align: center; padding: 3rem;">
                <i class="fas fa-shopping-bag" style="font-size: 4rem; color: var(--gray-400);"></i>
                <h2>Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng</h2>
                <p>Vui l√≤ng th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng tr∆∞·ªõc khi thanh to√°n</p>
                <button class="btn-primary" @onclick='() => Navigation.NavigateTo("/")'>
                    <i class="fas fa-arrow-left"></i>
                    Ti·∫øp t·ª•c mua s·∫Øm
                </button>
            </div>
        }
        else
        {
            <div class="checkout-grid">
                <!-- Left Column - Form -->
                <div class="checkout-form">
                    <!-- Shipping Information -->
                    <div class="form-section">
                        <h2 class="section-title">
                            <i class="fas fa-shipping-fast section-icon"></i>
                            Th√¥ng tin giao h√†ng
                        </h2>
                        
                        <div class="form-grid">
                            <div class="form-group form-grid-full">
                                <label class="form-label required">Email</label>
                                <input type="email" 
                                       class="form-input @GetValidationClass(nameof(OrderRequest.ReceiverEmail))"
                                       @bind="OrderRequest.ReceiverEmail"
                                       @onblur="() => ValidateField(nameof(OrderRequest.ReceiverEmail))"
                                       placeholder="email@example.com" />
                                @if (ValidationErrors.ContainsKey(nameof(OrderRequest.ReceiverEmail)))
                                {
                                    <span class="error-message">@ValidationErrors[nameof(OrderRequest.ReceiverEmail)]</span>
                                }
                            </div>

                            <div class="form-group">
                                <label class="form-label required">H·ªç v√† t√™n</label>
                                <input type="text" 
                                       class="form-input @GetValidationClass(nameof(OrderRequest.ReceiverName))"
                                       @bind="OrderRequest.ReceiverName"
                                       placeholder="Nguy·ªÖn VƒÉn A" />
                                @if (ValidationErrors.ContainsKey(nameof(OrderRequest.ReceiverName)))
                                {
                                    <span class="error-message">@ValidationErrors[nameof(OrderRequest.ReceiverName)]</span>
                                }
                            </div>

                            <div class="form-group">
                                <label class="form-label required">S·ªë ƒëi·ªán tho·∫°i</label>
                                <input type="tel" 
                                       class="form-input @GetValidationClass(nameof(OrderRequest.ReceiverPhone))"
                                       @bind="OrderRequest.ReceiverPhone"
                                       @onblur="() => ValidateField(nameof(OrderRequest.ReceiverPhone))"
                                       placeholder="0912345678" />
                                @if (ValidationErrors.ContainsKey(nameof(OrderRequest.ReceiverPhone)))
                                {
                                    <span class="error-message">@ValidationErrors[nameof(OrderRequest.ReceiverPhone)]</span>
                                }
                            </div>

                            <div class="form-group form-grid-full">
                                <label class="form-label required">ƒê·ªãa ch·ªâ chi ti·∫øt</label>
                                <input type="text" 
                                       class="form-input @GetValidationClass(nameof(OrderRequest.ShippingAddress))"
                                       @bind="OrderRequest.ShippingAddress"
                                       placeholder="S·ªë nh√†, t√™n ƒë∆∞·ªùng" />
                                @if (ValidationErrors.ContainsKey(nameof(OrderRequest.ShippingAddress)))
                                {
                                    <span class="error-message">@ValidationErrors[nameof(OrderRequest.ShippingAddress)]</span>
                                }
                            </div>

                            <div class="form-group">
                                <label class="form-label required">T·ªânh/Th√†nh ph·ªë</label>
                                <select class="form-select @GetValidationClass(nameof(OrderRequest.City))"
                                        @bind="OrderRequest.City">
                                    <option value="">Ch·ªçn T·ªânh/TP</option>
                                    <option value="hcm">TP. H·ªì Ch√≠ Minh</option>
                                    <option value="hn">H√† N·ªôi</option>
                                    <option value="dn">ƒê√† N·∫µng</option>
                                </select>
                                @if (ValidationErrors.ContainsKey(nameof(OrderRequest.City)))
                                {
                                    <span class="error-message">@ValidationErrors[nameof(OrderRequest.City)]</span>
                                }
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label required">Qu·∫≠n/Huy·ªán</label>
                                <select class="form-select @GetValidationClass(nameof(OrderRequest.District))"
                                        @bind="OrderRequest.District">
                                    <option value="">Ch·ªçn Qu·∫≠n/Huy·ªán</option>
                                    <option value="q1">Qu·∫≠n 1</option>
                                    <option value="q2">Qu·∫≠n 2</option>
                                    <option value="q3">Qu·∫≠n 3</option>
                                </select>
                                @if (ValidationErrors.ContainsKey(nameof(OrderRequest.District)))
                                {
                                    <span class="error-message">@ValidationErrors[nameof(OrderRequest.District)]</span>
                                }
                            </div>
                        </div>
                    </div>

                    <!-- Shipping Method -->
                    <div class="form-section">
                        <h2 class="section-title">
                            <i class="fas fa-truck section-icon"></i>
                            Ph∆∞∆°ng th·ª©c v·∫≠n chuy·ªÉn
                        </h2>
                        <div class="shipping-options">
                            @foreach (var option in ShippingOptions)
                            {
                                <div class="shipping-option @(OrderRequest.ShippingMethod == option.Id ? "selected" : "")"
                                     @onclick='() => SelectShipping(option)'>
                                    <div class="shipping-radio"></div>
                                    <div class="shipping-info">
                                        <div class="shipping-name">@option.Name</div>
                                        <div class="shipping-description">@option.Description</div>
                                    </div>
                                    <div class="shipping-price">@option.Price.ToString("N0")‚Ç´</div>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Payment Method -->
                    <div class="form-section">
                        <h2 class="section-title">
                            <i class="fas fa-credit-card section-icon"></i>
                            Ph∆∞∆°ng th·ª©c thanh to√°n
                        </h2>
                        <div class="payment-methods">
                            <div class="payment-method @(OrderRequest.PaymentMethod == "cod" ? "selected" : "")"
                                 @onclick='() => OrderRequest.PaymentMethod = "cod"'>
                                <div class="payment-icon">üíµ</div>
                                <div class="payment-name">COD</div>
                                <div class="payment-badge">‚úì</div>
                            </div>

                            <div class="payment-method @(OrderRequest.PaymentMethod == "card" ? "selected" : "")"
                                 @onclick='() => OrderRequest.PaymentMethod = "card"'>
                                <div class="payment-icon">üí≥</div>
                                <div class="payment-name">Th·∫ª t√≠n d·ª•ng</div>
                                <div class="payment-badge">‚úì</div>
                            </div>

                            <div class="payment-method @(OrderRequest.PaymentMethod == "wallet" ? "selected" : "")"
                                 @onclick='() => OrderRequest.PaymentMethod = "wallet"'>
                                <div class="payment-icon">üì±</div>
                                <div class="payment-name">V√≠ ƒëi·ªán t·ª≠</div>
                                <div class="payment-badge">‚úì</div>
                            </div>

                            <div class="payment-method @(OrderRequest.PaymentMethod == "transfer" ? "selected" : "")"
                                 @onclick='() => OrderRequest.PaymentMethod = "transfer"'>
                                <div class="payment-icon">üè¶</div>
                                <div class="payment-name">Chuy·ªÉn kho·∫£n</div>
                                <div class="payment-badge">‚úì</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column - Order Summary -->
                <div class="order-summary">
                    <h3 class="summary-title">ƒê∆°n h√†ng c·ªßa b·∫°n</h3>

                    <!-- Products -->
                    <div class="summary-items">
                        @if (AuthService.IsAuthenticated && ApiCart?.Items != null)
                        {
                            @foreach (var item in ApiCart.Items)
                            {
                                <div class="summary-item">
                                    <img src="@item.ImageUrl" alt="@item.ProductName" class="summary-item-image" />
                                    <div class="summary-item-details">
                                        <div class="summary-item-name">@item.ProductName</div>
                                        <div class="summary-item-info">Size: @item.Size ‚Ä¢ @item.Color</div>
                                        <div class="summary-item-price">
                                            <span class="item-quantity">x @item.Quantity</span>
                                            <span class="item-total">@item.TotalPriceFormatted</span>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            @foreach (var item in LocalCartItems)
                            {
                                <div class="summary-item">
                                    <img src="@item.Product.PrimaryImageUrl" alt="@item.Product.Name" class="summary-item-image" />
                                    <div class="summary-item-details">
                                        <div class="summary-item-name">@item.Product.Name</div>
                                        <div class="summary-item-info">Size: @item.SelectedSize ‚Ä¢ @GetColorName(item.SelectedColor)</div>
                                        <div class="summary-item-price">
                                            <span class="item-quantity">x @item.Quantity</span>
                                            <span class="item-total">@((item.Product.Price * item.Quantity).ToString("N0"))‚Ç´</span>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                    </div>

                    <!-- Calculations -->
                    <div class="summary-calculations">
                        <div class="summary-row">
                            <span class="summary-label">T·∫°m t√≠nh</span>
                            <span class="summary-value">@GetSubTotal()</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Ph√≠ v·∫≠n chuy·ªÉn</span>
                            <span class="summary-value">@ShippingFee.ToString("N0")‚Ç´</span>
                        </div>
                        @if (Discount > 0)
                        {
                            <div class="summary-row discount">
                                <span class="summary-label">Gi·∫£m gi√°</span>
                                <span class="summary-value">-@Discount.ToString("N0")‚Ç´</span>
                            </div>
                        }
                        <div class="summary-row total">
                            <span class="summary-label">T·ªïng c·ªông</span>
                            <span class="summary-value">@GetTotalAmount()</span>
                        </div>
                    </div>

                    <!-- Checkout Button -->
                    <button class="btn-checkout" 
                            @onclick="HandleCheckout"
                            disabled="@IsProcessing">
                        @if (IsProcessing)
                        {
                            <i class="fas fa-spinner fa-spin"></i>
                            <span>ƒêang x·ª≠ l√Ω...</span>
                        }
                        else
                        {
                            <i class="fas fa-check-circle"></i>
                            <span>Ho√†n t·∫•t ƒë∆°n h√†ng</span>
                        }
                    </button>

                    <div class="security-badge">
                        <i class="fas fa-shield-alt security-icon"></i>
                        <span>Giao d·ªãch b·∫£o m·∫≠t SSL</span>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@code {
    private CreateOrderRequest OrderRequest = new() { PaymentMethod = "cod", ShippingMethod = "standard" };
    private Dictionary<string, string> ValidationErrors = new();
    private CartSummaryResponse? ApiCart = null;
    private List<WebUI.Services.CartItem> LocalCartItems = new();
    private bool IsProcessing = false;
    private decimal ShippingFee = 30000;
    private decimal Discount = 0;
    private string DiscountCode = string.Empty;

    private List<ShippingOption> ShippingOptions = new()
    {
        new ShippingOption { Id = "standard", Name = "Ti√™u chu·∫©n", Description = "3-5 ng√†y", Price = 30000 },
        new ShippingOption { Id = "express", Name = "Nhanh", Description = "1-2 ng√†y", Price = 50000 },
        new ShippingOption { Id = "super", Name = "H·ªèa t·ªëc", Description = "< 24 gi·ªù", Price = 100000 }
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadCartAsync();
        
        if (AuthService.IsAuthenticated && AuthService.CurrentUser != null)
        {
            var user = AuthService.CurrentUser;
            OrderRequest.ReceiverName = user.FullName ?? "";
            OrderRequest.ReceiverPhone = user.Phone ?? "";
            OrderRequest.ReceiverEmail = user.Email ?? "";
        }
    }

    private async Task LoadCartAsync()
    {
        if (AuthService.IsAuthenticated)
        {
            var fullCart = await CartService.GetCartFromApiAsync();
            
            // Filter to only selected items
            if (fullCart != null && CartService.SelectedApiCartItemIds.Any())
            {
                // Create a filtered cart with only selected items
                var filteredItems = fullCart.Items
                    .Where(item => CartService.SelectedApiCartItemIds.Contains(item.CartItemID))
                    .ToList();
                
                // Create new CartSummaryResponse with filtered items
                ApiCart = new CartSummaryResponse
                {
                    CartID = fullCart.CartID,
                    Items = filteredItems
                };
            }
            else if (fullCart != null)
            {
                // No selection - take all items
                ApiCart = fullCart;
            }
        }
        else
        {
            var allItems = CartService.GetItems();
            
            // Filter to only selected items
            if (CartService.SelectedLocalProductIds.Any())
            {
                LocalCartItems = allItems
                    .Where(item => CartService.SelectedLocalProductIds.Contains(item.Product.Id))
                    .ToList();
            }
            else
            {
                // No selection - take all items
                LocalCartItems = allItems;
            }
        }
    }

    private bool HasCartItems()
    {
        return AuthService.IsAuthenticated ? ApiCart?.Items.Any() == true : LocalCartItems.Any();
    }

    private void SelectShipping(ShippingOption option)
    {
        OrderRequest.ShippingMethod = option.Id;
        ShippingFee = option.Price;
        StateHasChanged();
    }

    private void ApplyDiscount()
    {
        if (DiscountCode.ToUpper() == "SAVE200K")
        {
            Discount = 200000;
            OrderRequest.Discount = Discount;
            OrderRequest.CouponCode = DiscountCode;
        }
    }

    private string GetSubTotal()
    {
        if (AuthService.IsAuthenticated && ApiCart != null)
        {
            return $"{ApiCart.TotalAmount:N0}‚Ç´";
        }
        // Calculate from filtered LocalCartItems
        return $"{LocalCartItems.Sum(item => item.Product.Price * item.Quantity):N0}‚Ç´";
    }

    private string GetTotalAmount()
    {
        decimal subTotal = AuthService.IsAuthenticated && ApiCart != null 
            ? ApiCart.TotalAmount 
            : LocalCartItems.Sum(item => item.Product.Price * item.Quantity);
        
        decimal total = subTotal + ShippingFee - Discount;
        return $"{total:N0}‚Ç´";
    }

    private async Task HandleCheckout()
    {
        ValidationErrors.Clear();

        if (!ValidateForm())
        {
            await ToastService.ShowError("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc");
            return;
        }

        IsProcessing = true;
        LoadingService.Show("ƒêang x·ª≠ l√Ω ƒë∆°n h√†ng", "Vui l√≤ng ƒë·ª£i trong gi√¢y l√°t...");

        try
        {
            if (AuthService.IsAuthenticated && ApiCart?.Items != null)
            {
                OrderRequest.Items = ApiCart.Items.Select(item => new OrderItemRequest
                {
                    ProductId = item.ProductID,
                    ProductName = item.ProductName,
                    Quantity = item.Quantity,
                    Price = item.Price,
                    SelectedSize = item.Size,
                    SelectedColor = item.Color,
                    ImageUrl = item.ImageUrl
                }).ToList();
            }
            else
            {
                OrderRequest.Items = LocalCartItems.Select(item => new OrderItemRequest
                {
                    ProductId = item.Product.Id,
                    ProductName = item.Product.Name,
                    Quantity = item.Quantity,
                    Price = item.Product.Price,
                    SelectedSize = item.SelectedSize,
                    SelectedColor = item.SelectedColor,
                    ImageUrl = item.Product.PrimaryImageUrl
                }).ToList();
            }

            OrderRequest.ShippingFee = ShippingFee;
            OrderRequest.Discount = Discount;

            var response = await OrderService.CreateOrderAsync(OrderRequest);

            if (response.Success)
            {
                await ToastService.ShowSuccess("ƒê·∫∑t h√†ng th√†nh c√¥ng!");
                
                // Clear selected items
                CartService.SelectedApiCartItemIds.Clear();
                CartService.SelectedLocalProductIds.Clear();
                
                if (AuthService.IsAuthenticated)
                {
                    await CartService.ClearCartAsync();
                }
                else
                {
                    CartService.ClearCart();
                }

                Navigation.NavigateTo(response.Data?.OrderId != null 
                    ? $"/order-success/{response.Data.OrderId}" 
                    : "/order-success");
            }
            else
            {
                await ToastService.ShowError($"ƒê·∫∑t h√†ng th·∫•t b·∫°i: {response.Message}");
            }
        }
        catch (Exception ex)
        {
            await ToastService.ShowError($"C√≥ l·ªói x·∫£y ra: {ex.Message}");
        }
        finally
        {
            IsProcessing = false;
            LoadingService.Hide();
        }
    }

    private bool ValidateForm()
    {
        bool isValid = true;

        if (string.IsNullOrWhiteSpace(OrderRequest.ReceiverName))
        {
            ValidationErrors[nameof(OrderRequest.ReceiverName)] = "Vui l√≤ng nh·∫≠p h·ªç t√™n";
            isValid = false;
        }

        if (string.IsNullOrWhiteSpace(OrderRequest.ReceiverPhone))
        {
            ValidationErrors[nameof(OrderRequest.ReceiverPhone)] = "Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i";
            isValid = false;
        }
        else if (!System.Text.RegularExpressions.Regex.IsMatch(OrderRequest.ReceiverPhone, @"^0\d{9,10}$"))
        {
            ValidationErrors[nameof(OrderRequest.ReceiverPhone)] = "S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá";
            isValid = false;
        }

        if (string.IsNullOrWhiteSpace(OrderRequest.City))
        {
            ValidationErrors[nameof(OrderRequest.City)] = "Vui l√≤ng ch·ªçn T·ªânh/Th√†nh ph·ªë";
            isValid = false;
        }

        if (string.IsNullOrWhiteSpace(OrderRequest.District))
        {
            ValidationErrors[nameof(OrderRequest.District)] = "Vui l√≤ng ch·ªçn Qu·∫≠n/Huy·ªán";
            isValid = false;
        }

        if (string.IsNullOrWhiteSpace(OrderRequest.ShippingAddress))
        {
            ValidationErrors[nameof(OrderRequest.ShippingAddress)] = "Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ c·ª• th·ªÉ";
            isValid = false;
        }

        return isValid;
    }

    private void ValidateField(string fieldName)
    {
        if (fieldName == nameof(OrderRequest.ReceiverEmail) && !string.IsNullOrWhiteSpace(OrderRequest.ReceiverEmail))
        {
            if (!System.Text.RegularExpressions.Regex.IsMatch(OrderRequest.ReceiverEmail, @"^[^\s@]+@[^\s@]+\.[^\s@]+$"))
            {
                ValidationErrors[fieldName] = "Email kh√¥ng h·ª£p l·ªá";
            }
            else
            {
                ValidationErrors.Remove(fieldName);
            }
        }
        else if (fieldName == nameof(OrderRequest.ReceiverPhone) && !string.IsNullOrWhiteSpace(OrderRequest.ReceiverPhone))
        {
            if (!System.Text.RegularExpressions.Regex.IsMatch(OrderRequest.ReceiverPhone, @"^0\d{9,10}$"))
            {
                ValidationErrors[fieldName] = "S·ªë ƒëi·ªán tho·∫°i ph·∫£i c√≥ 10 ch·ªØ s·ªë";
            }
            else
            {
                ValidationErrors.Remove(fieldName);
            }
        }
    }

    private string GetValidationClass(string fieldName)
    {
        return ValidationErrors.ContainsKey(fieldName) ? "error" : "";
    }

    private string GetColorName(string? colorHex)
    {
        if (string.IsNullOrEmpty(colorHex)) return "";
        
        return colorHex.ToUpper() switch
        {
            "#000000" => "ƒêen",
            "#FFFFFF" => "Tr·∫Øng",
            "#808080" => "X√°m",
            "#000080" => "Xanh Navy",
            "#FF0000" => "ƒê·ªè",
            _ => "M√†u kh√°c"
        };
    }
}
