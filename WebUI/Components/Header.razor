@using WebUI.Components
@using WebUI.Services
@using WebUI.Services.Interfaces
@using WebUI.Models.Cart
@inject CartService CartService
@inject IAuthService AuthService
@inject NavigationManager Navigation
@implements IDisposable

<!-- Header Component -->
<header class="header">
    <div class="header-container">
        <a href="/" class="logo">Asion</a>
        
        <nav>
            <ul class="nav-menu">
                <li><a href="/new-balance">New Balance</a></li>
                <li><a href="/asics">Asics</a></li>
                <li><a href="/converse">Converse</a></li>
                <li><a href="/sale">Sale</a></li>
            </ul>
        </nav>

        <div class="header-icons">
            <i class="fas fa-search" @onclick="OnSearchClick"></i>
            
            <!-- User Dropdown Component -->
            <UserDropdown />
            
            <div class="cart-icon" @onclick="OnCartClick">
                <i class="fas fa-shopping-bag"></i>
                @if (CartItemsCount > 0)
                {
                    <span class="cart-badge">@CartItemsCount</span>
                }
            </div>
        </div>
    </div>
</header>

<!-- Cart Summary Dropdown -->
@if (ShowCartSummary)
{
    <div class="cart-dropdown-overlay" @onclick="() => OnCartSummaryVisibilityChanged(false)">
        <div class="cart-dropdown-content" @onclick:stopPropagation="true">
            <div class="cart-header">
                <h3>Giỏ hàng (@CartItemsCount sản phẩm)</h3>
                <button class="close-btn" @onclick="() => OnCartSummaryVisibilityChanged(false)">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            @if (CartItemsCount > 0)
            {
                <div class="cart-items-list">
                    @if (AuthService?.IsAuthenticated == true && ApiCart?.Items != null)
                    {
                        @* Render API Cart Items *@
                        @foreach (var apiItem in ApiCart.Items)
                        {
                            <div class="cart-item-row">
                                <img src="@apiItem.ImageUrl" alt="@apiItem.ProductName" class="item-thumb" />
                                <div class="item-info">
                                    <h4>@apiItem.ProductName</h4>
                                    <p>@apiItem.Brand</p>
                                    <div class="item-price-qty">
                                        <span>@apiItem.PriceFormatted x @apiItem.Quantity</span>
                                    </div>
                                </div>
                                <button class="remove-item-btn" @onclick="() => RemoveApiCartItem(apiItem.CartItemID)">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        }
                    }
                    else
                    {
                        @* Render Local Cart Items *@
                        @foreach (var item in LocalCartItems)
                        {
                            <div class="cart-item-row">
                                <img src="@item.Product.PrimaryImageUrl" alt="@item.Product.Name" class="item-thumb" />
                                <div class="item-info">
                                    <h4>@item.Product.Name</h4>
                                    <p>@item.Product.Brand</p>
                                    <div class="item-price-qty">
                                        <span>@item.Product.PriceFormatted x @item.Quantity</span>
                                    </div>
                                </div>
                                <button class="remove-item-btn" @onclick="() => RemoveCartItem(item.Product.Id)">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        }
                    }
                </div>
                
                <div class="cart-footer">
                    <div class="cart-total">
                        <strong>Tổng: @GetCartTotal()</strong>
                    </div>
                    <div class="cart-actions">
                        <button class="btn btn-outline" @onclick="ViewCart">Xem giỏ hàng</button>
                        <button class="btn btn-primary" @onclick="Checkout">Thanh toán</button>
                    </div>
                </div>
            }
            else
            {
                <div class="empty-cart">
                    <i class="fas fa-shopping-bag"></i>
                    <p>Giỏ hàng trống</p>
                </div>
            }
        </div>
    </div>
}

@code {
    private int CartItemsCount = 0;
    private bool ShowCartSummary = false;
    private CartSummaryResponse? ApiCart = null;
    private List<WebUI.Services.CartItem> LocalCartItems = new();

    protected override async Task OnInitializedAsync()
    {
        CartService.OnCartChanged += UpdateCart;
        AuthService.AuthStateChanged += OnAuthStateChanged;
        
        // Wait for AuthService to initialize
        await Task.Delay(100);
        await LoadCartAsync();
    }

    private async void OnAuthStateChanged(object? sender, bool isAuthenticated)
    {
        await LoadCartAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadCartAsync()
    {
        try
        {
            if (AuthService?.IsAuthenticated == true)
            {
                ApiCart = await CartService.GetCartFromApiAsync();
                CartItemsCount = ApiCart?.TotalItems ?? 0;
                LocalCartItems.Clear();
            }
            else
            {
                ApiCart = null;
                LocalCartItems = CartService.GetItems();
                CartItemsCount = CartService.GetTotalItems();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[Header] Error loading cart: {ex.Message}");
            LocalCartItems = CartService.GetItems();
            CartItemsCount = CartService.GetTotalItems();
            ApiCart = null;
        }
    }

    private async void UpdateCart()
    {
        await LoadCartAsync();
        await InvokeAsync(StateHasChanged);
    }

    private void OnSearchClick()
    {
        // Handle search click
    }

    private void OnUserClick()
    {
        // This method is no longer needed since UserDropdown handles user interaction
    }

    private async Task OnCartClick()
    {
        ShowCartSummary = !ShowCartSummary;
        
        if (ShowCartSummary)
        {
            await LoadCartAsync();
        }
        
        StateHasChanged();
    }

    private void OnCartSummaryVisibilityChanged(bool isVisible)
    {
        ShowCartSummary = isVisible;
        StateHasChanged();
    }

    private void RemoveCartItem(int productId)
    {
        CartService.RemoveItem(productId);
    }

    private async Task RemoveApiCartItem(int cartItemId)
    {
        var success = await CartService.RemoveCartItemAsync(cartItemId);
        
        if (success)
        {
            await LoadCartAsync();
            StateHasChanged();
        }
    }

    private string GetCartTotal()
    {
        if (AuthService?.IsAuthenticated == true && ApiCart != null)
        {
            return $"{ApiCart.TotalAmount:N0}đ";
        }
        return $"{CartService.GetTotalPrice():N0}đ";
    }

    private void ViewCart()
    {
        // Navigate to cart page
        ShowCartSummary = false;
        Navigation.NavigateTo("/cart");
    }

    private void Checkout()
    {
        // Navigate to checkout
        ShowCartSummary = false;
        // Navigation.NavigateTo("/checkout");
    }

    public void Dispose()
    {
        CartService.OnCartChanged -= UpdateCart;
        AuthService.AuthStateChanged -= OnAuthStateChanged;
    }
}