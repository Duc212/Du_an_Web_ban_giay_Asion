@using WebUI.Models
@using WebUI.Services
@using WebUI.Services.Interfaces
@inject NavigationManager Navigation
@inject CartService CartService
@inject IJSRuntime JSRuntime
@inject IToastService ToastService
@inject IAuthService AuthService
@inject IProductService ProductService

<!-- Product Card Component -->
<div class="product-card" @onclick="OnProductClick">
    <div class="card-media">
        @if (Product.HasBadge)
        {
            <span class="product-badge @(Product.IsSale ? "product-badge--sale" : "product-badge--highlight")">
                @Product.Badge
            </span>
        }

        <img src="@Product.ImageUrl"
             alt="@Product.Name"
             class="card-image"
             onerror="this.style.display='none'; this.nextElementSibling.classList.remove('hidden');" />

        <div class="image-fallback hidden">
            <i class="fas fa-shoe-prints"></i>
        </div>

        <div class="card-actions">
            <button class="action-btn action-btn--primary"
                    title="Xem nhanh"
                    @onclick="OnQuickViewClick"
                    @onclick:stopPropagation="true">
                <i class="fas fa-eye"></i>
            </button>
            <button class="action-btn action-btn--accent"
                    title="Thêm vào giỏ"
                    @onclick="OnAddToCartClick"
                    @onclick:stopPropagation="true">
                <i class="fas fa-shopping-cart"></i>
            </button>
            <button class="action-btn action-btn--ghost @(isFavorite ? "is-favorite" : "")"
                    title="@(isFavorite ? "Bỏ yêu thích" : "Yêu thích")"
                    @onclick="OnWishlistClick"
                    @onclick:stopPropagation="true"
                    disabled="@isTogglingFavorite">
                <i class="@(isFavorite ? "fas" : "far") fa-heart"></i>
            </button>
        </div>
    </div>

    <div class="card-content">
        <span class="product-brand">@Product.Brand</span>
        <h3 class="product-title" title="@Product.Name">@Product.Name</h3>

        <div class="product-pricing">
            <span class="product-price">@Product.PriceFormatted</span>
            @if (Product.OriginalPrice.HasValue)
            {
                <span class="product-price--old">@Product.OldPriceFormatted</span>
            }
            @if (Product.Discount.HasValue)
            {
                <span class="product-discount">-@(Product.Discount.Value)%</span>
            }
        </div>

        <div class="product-rating">
            <div class="stars">
                @for (var i = 1; i <= 5; i++)
                {
                    var starClass = i <= Math.Floor(Product.Rating) ? "fas" : 
                                  i - Math.Floor(Product.Rating) <= 0.5 ? "fas fa-star-half-alt" : "far";
                    <i class="@($"{starClass} fa-star")"></i>
                }
            </div>
            <span class="rating-count">(@Product.ReviewCount đánh giá)</span>
        </div>
    </div>
</div>

<SizeColorSelectionModal Product="Product"
                        IsVisible="ShowModal"
                        OnClose="CloseModal"
                        OnAddToCart="OnModalAddToCart" />

@code {
    [Parameter] public Product Product { get; set; } = new();
    [Parameter] public EventCallback<Product> OnProductSelected { get; set; }
    [Parameter] public EventCallback<Product> OnQuickView { get; set; }

    private bool ShowModal = false;
    private bool isFavorite = false;
    private bool isTogglingFavorite = false;

    private async Task OnProductClick()
    {
        // Navigate to product detail page
        Navigation.NavigateTo($"/product/{Product.Id}");
        await OnProductSelected.InvokeAsync(Product);
    }

    private async Task OnQuickViewClick()
    {
        // Navigate to product detail page
        Navigation.NavigateTo($"/product/{Product.Id}");
        await OnQuickView.InvokeAsync(Product);
    }

    private async Task OnAddToCartClick()
    {
        // Show modal for size/color selection
        ShowModal = true;
        StateHasChanged();
    }

    private async Task CloseModal()
    {
        ShowModal = false;
        StateHasChanged();
    }

    private async Task OnModalAddToCart(string message)
    {
        if (message.Contains("thành công") || message.Contains("Thêm"))
        {
            await ToastService.ShowSuccess("Đã thêm vào giỏ hàng!");
        }
        else
        {
            await ToastService.ShowError(message);
        }
    }

    private async Task OnWishlistClick()
    {
        // Check if user is logged in
        if (!AuthService.IsAuthenticated)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        isTogglingFavorite = true;
        StateHasChanged();

        try
        {
            if (isFavorite)
            {
                // Remove from favorites
                var result = await ProductService.RemoveFavoriteProductAsync(Product.Id);
                if (result.Success)
                {
                    isFavorite = false;
                    await ToastService.ShowSuccess("Đã bỏ yêu thích");
                }
                else
                {
                    await ToastService.ShowError("Không thể bỏ yêu thích");
                }
            }
            else
            {
                // Add to favorites
                var result = await ProductService.AddFavoriteProductAsync(Product.Id);
                if (result.Success)
                {
                    isFavorite = true;
                    await ToastService.ShowSuccess($"Đã thêm {Product.Name} vào yêu thích!");
                }
                else
                {
                    await ToastService.ShowError("Không thể thêm vào yêu thích");
                }
            }
        }
        finally
        {
            isTogglingFavorite = false;
            StateHasChanged();
        }
    }
}