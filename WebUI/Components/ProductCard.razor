@using WebUI.Models
@using WebUI.Services
@inject NavigationManager Navigation
@inject CartService CartService
@inject IJSRuntime JSRuntime

<!-- Product Card Component -->
<div class="product-card" @onclick="OnProductClick">
    <div class="card-media">
        @if (Product.HasBadge)
        {
            <span class="product-badge @(Product.IsSale ? "product-badge--sale" : "product-badge--highlight")">
                @Product.Badge
            </span>
        }

        <img src="@Product.PrimaryImageUrl"
             alt="@Product.Name"
             class="card-image"
             onerror="this.style.display='none'; this.nextElementSibling.classList.remove('hidden');" />

        <div class="image-fallback hidden">
            <i class="fas fa-shoe-prints"></i>
        </div>

        <div class="card-actions">
            <button class="action-btn action-btn--primary"
                    title="Xem nhanh"
                    @onclick="OnQuickViewClick"
                    @onclick:stopPropagation="true">
                <i class="fas fa-eye"></i>
            </button>
            <button class="action-btn action-btn--accent"
                    title="Thêm vào giỏ"
                    @onclick="OnAddToCartClick"
                    @onclick:stopPropagation="true">
                <i class="fas fa-shopping-cart"></i>
            </button>
            <button class="action-btn action-btn--ghost"
                    title="Yêu thích"
                    @onclick="OnWishlistClick"
                    @onclick:stopPropagation="true">
                <i class="far fa-heart"></i>
            </button>
        </div>
    </div>

    <div class="card-content">
        <span class="product-brand">@Product.Brand</span>
        <h3 class="product-title" title="@Product.Name">@Product.Name</h3>

        <div class="product-pricing">
            <span class="product-price">@Product.PriceFormatted</span>
            @if (Product.OriginalPrice.HasValue)
            {
                <span class="product-price--old">@Product.OldPriceFormatted</span>
            }
            @if (!string.IsNullOrEmpty(Product.Discount))
            {
                <span class="product-discount">@Product.Discount</span>
            }
        </div>
    </div>
</div>

<SizeColorSelectionModal Product="Product"
                        IsVisible="ShowModal"
                        OnClose="CloseModal"
                        OnAddToCart="OnModalAddToCart" />

@code {
    [Parameter] public Product Product { get; set; } = new();
    [Parameter] public EventCallback<Product> OnProductSelected { get; set; }
    [Parameter] public EventCallback<Product> OnQuickView { get; set; }

    private bool ShowModal = false;

    private async Task OnProductClick()
    {
        // Navigate to product detail page
        Navigation.NavigateTo($"/product/{Product.Id}");
        await OnProductSelected.InvokeAsync(Product);
    }

    private async Task OnQuickViewClick()
    {
        // Navigate to product detail page
        Navigation.NavigateTo($"/product/{Product.Id}");
        await OnQuickView.InvokeAsync(Product);
    }

    private async Task OnAddToCartClick()
    {
        // Show modal for size/color selection
        ShowModal = true;
        StateHasChanged();
    }

    private async Task CloseModal()
    {
        ShowModal = false;
        StateHasChanged();
    }

    private async Task OnModalAddToCart(string message)
    {
        // Show success toast notification
        await JSRuntime.InvokeVoidAsync("eval", $@"
            (function() {{
                let toast = document.createElement('div');
                toast.innerHTML = '<i class=""fas fa-check-circle me-2""></i>{message}';
                toast.style.cssText = 'position:fixed;top:20px;right:20px;background:linear-gradient(135deg, #4CAF50, #45a049);color:white;padding:16px 24px;border-radius:12px;z-index:9999;font-weight:600;box-shadow:0 8px 24px rgba(0,0,0,0.15);display:flex;align-items:center;gap:8px;font-size:14px;animation: slideInRight 0.4s cubic-bezier(0.4, 0, 0.2, 1);';
                document.body.appendChild(toast);
                setTimeout(function() {{
                    toast.style.animation = 'slideOutRight 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
                    setTimeout(function() {{ toast.remove(); }}, 400);
                }}, 2500);
            }})();
        ");
    }

    private async Task OnWishlistClick()
    {
        // Add to wishlist with toast notification
        await JSRuntime.InvokeVoidAsync("eval", $@"
            (function() {{
                let toast = document.createElement('div');
                toast.innerHTML = '<i class=""fas fa-heart me-2""></i>Đã thêm ""{Product.Name}"" vào danh sách yêu thích!';
                toast.style.cssText = 'position:fixed;top:20px;right:20px;background:linear-gradient(135deg, #FF6B6B, #FF5252);color:white;padding:16px 24px;border-radius:12px;z-index:9999;font-weight:600;box-shadow:0 8px 24px rgba(0,0,0,0.15);display:flex;align-items:center;gap:8px;font-size:14px;animation: slideInRight 0.4s cubic-bezier(0.4, 0, 0.2, 1);';
                document.body.appendChild(toast);
                setTimeout(function() {{
                    toast.style.animation = 'slideOutRight 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
                    setTimeout(function() {{ toast.remove(); }}, 400);
                }}, 2500);
            }})();
        ");
    }
}