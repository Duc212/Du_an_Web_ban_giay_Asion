@page "/orders/{OrderId}"
@inject AdminWeb.Services.OrderService OrderService
@inject AdminWeb.Services.ToastService Toast
@using DAL.DTOs.Orders.Res

@code {
    [Parameter] public string OrderId { get; set; } = string.Empty;
    private GetOrderRes? order;
    private bool loading = true;
    private bool showRejectModal = false;
    private string rejectReason = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        order = await OrderService.GetOrderAsync(OrderId);
        loading = false;
    }

    private string GetStatusClass(int status) => status switch
    {
        0 => "bg-orange-100 text-orange-600",
        1 => "bg-blue-100 text-blue-600",
        2 => "bg-cyan-100 text-cyan-600",
        3 => "bg-emerald-100 text-emerald-600",
        4 => "bg-red-100 text-red-600",
        _ => "bg-gray-100 text-gray-600"
    };

    private string GetStatusText(int status) => status switch
    {
        0 => "Chờ xử lý",
        1 => "Đang xử lý",
        2 => "Đang giao",
        3 => "Hoàn thành",
        4 => "Đã hủy",
        _ => "Không xác định"
    };

    private string GetPaymentMethod(int method) => method switch
    {
        0 => "COD",
        1 => "Chuyển khoản",
        2 => "Ví điện tử",
        3 => "Thẻ tín dụng",
        _ => "Khác"
    };

    private string GetPaymentStatusText(int st) => st == 1 ? "Đã thanh toán" : "Chưa thanh toán";
    private string GetPaymentStatusClass(int st) => st == 1 ? "text-emerald-600" : "text-red-600";

    private async Task Accept() { if (order == null) return; var ok = await OrderService.UpdateStatusAsync(order.OrderId,1); if(ok){ order.Status=1; Toast.Success("Đã chuyển sang xử lý"); StateHasChanged(); } }
    private async Task Reject() { if (order == null) return; var ok = await OrderService.UpdateStatusAsync(order.OrderId,4); if(ok){ if(!string.IsNullOrWhiteSpace(rejectReason)) order.Note = "Từ chối: " + rejectReason.Trim(); order.Status=4; Toast.Error("Đã hủy đơn"); showRejectModal=false; rejectReason=string.Empty; StateHasChanged(); } }
    private async Task Ship() { if (order == null) return; var ok = await OrderService.UpdateStatusAsync(order.OrderId,2); if(ok){ order.Status=2; Toast.Info("Đang giao hàng"); StateHasChanged(); } }
    private async Task Complete() { if (order == null) return; var ok = await OrderService.UpdateStatusAsync(order.OrderId,3); if(ok){ order.Status=3; Toast.Success("Hoàn thành đơn hàng"); StateHasChanged(); } }
}

<PageTitle>Chi tiết đơn hàng</PageTitle>

@if (loading)
{
    <div class="flex items-center justify-center py-20"><div class="animate-spin rounded-full h-14 w-14 border-t-2 border-b-2 border-blue-500"></div></div>
}
else if (order == null)
{
    <div class="max-w-3xl mx-auto mt-10 p-8 bg-white rounded-2xl shadow">
        <h2 class="text-xl font-bold mb-2">Không tìm thấy đơn hàng</h2>
        <p class="text-gray-600 mb-6">Vui lòng kiểm tra lại mã đơn hoặc quay về danh sách.</p>
        <a href="/orders" class="px-5 py-2 inline-flex items-center gap-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700"><i class="fas fa-arrow-left"></i><span>Quay lại</span></a>
    </div>
}
else
{
    <div class="space-y-6">
        <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-6">
            <div class="space-y-2">
                <h1 class="text-2xl font-bold">Đơn hàng #@order.OrderNumber</h1>
                <div class="flex flex-wrap gap-2 items-center text-sm">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold @GetStatusClass(order.Status) shadow-sm">@GetStatusText(order.Status)</span>
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-indigo-50 text-indigo-600"><i class="fa-solid fa-credit-card mr-1"></i>@GetPaymentMethod(order.PaymentMethod)</span>
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-gray-100 @GetPaymentStatusClass(order.PaymentStatus)"><i class="fa-solid fa-wallet mr-1"></i>@GetPaymentStatusText(order.PaymentStatus)</span>
                </div>
                <p class="text-xs text-gray-500">Tạo lúc @order.CreatedAt.ToString("dd/MM/yyyy HH:mm")</p>
            </div>
            <div class="flex items-center gap-2 flex-wrap">
                @if(order.Status == 0)
                {
                    <button @onclick="Accept" class="px-4 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white text-sm font-medium"><i class="fa-solid fa-check mr-1"></i> Xác nhận</button>
                    <button @onclick="() => showRejectModal = true" class="px-4 py-2 rounded-lg bg-red-500 hover:bg-red-600 text-white text-sm font-medium"><i class="fa-solid fa-times mr-1"></i> Từ chối</button>
                }
                else if(order.Status == 1)
                {
                    <button @onclick="Ship" class="px-4 py-2 rounded-lg bg-cyan-500 hover:bg-cyan-600 text-white text-sm font-medium"><i class="fa-solid fa-truck mr-1"></i> Giao hàng</button>
                    <button @onclick="() => showRejectModal = true" class="px-4 py-2 rounded-lg bg-red-500 hover:bg-red-600 text-white text-sm font-medium"><i class="fa-solid fa-ban mr-1"></i> Hủy</button>
                }
                else if(order.Status == 2)
                {
                    <button @onclick="Complete" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium"><i class="fa-solid fa-flag-checkered mr-1"></i> Hoàn thành</button>
                }
                    <a href="/orders" class="px-4 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-sm font-medium"><i class="fa-solid fa-arrow-left mr-1"></i> Quay lại</a>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 space-y-6">
                <div class="bg-white rounded-xl shadow p-6">
                    <h3 class="text-sm font-bold uppercase text-gray-600 mb-4">Thông tin khách hàng</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                        <div><span class="font-semibold">Họ tên:</span> @order.ReceiverName</div>
                        <div><span class="font-semibold">Điện thoại:</span> @order.ReceiverPhone</div>
                        <div><span class="font-semibold">Email:</span> @order.ReceiverEmail</div>
                        <div><span class="font-semibold">Mã khách:</span> @order.UserId</div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow p-6">
                    <h3 class="text-sm font-bold uppercase text-gray-600 mb-4">Địa chỉ giao hàng</h3>
                    <p class="text-sm">@order.ShippingAddress</p>
                    <p class="text-xs text-gray-500 mt-2">@order.Ward @order.District @order.City</p>
                </div>
                <div class="bg-white rounded-xl shadow p-6">
                    <h3 class="text-sm font-bold uppercase text-gray-600 mb-4">Sản phẩm</h3>
                    <div class="overflow-auto border rounded-lg">
                        <table class="min-w-full">
                            <thead class="bg-gray-50 text-xs uppercase">
                                <tr>
                                    <th class="px-4 py-3 text-left">Sản phẩm</th>
                                    <th class="px-4 py-3 text-center">SL</th>
                                    <th class="px-4 py-3 text-right">Đơn giá</th>
                                    <th class="px-4 py-3 text-right">Thành tiền</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100 bg-white">
                                @foreach(var item in order.Items)
                                {
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-4 py-3">
                                            <div class="flex items-center">
                                                <img src="@item.ImageUrl" alt="img" class="w-12 h-12 rounded-lg object-cover mr-3" />
                                                <div>
                                                    <p class="text-sm font-semibold">@item.ProductName</p>
                                                    <p class="text-[11px] text-gray-500">Size: @item.SelectedSize • Màu: @item.SelectedColor</p>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-4 py-3 text-center text-sm">@item.Quantity</td>
                                        <td class="px-4 py-3 text-right text-sm">@item.Price.ToString("N0") ₫</td>
                                        <td class="px-4 py-3 text-right text-sm font-semibold">@( (item.Price * item.Quantity).ToString("N0") ) ₫</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="space-y-6">
                <div class="bg-white rounded-xl shadow p-6">
                    <h3 class="text-sm font-bold uppercase text-gray-600 mb-4">Tổng kết</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between"><span>Tạm tính</span><span>@order.SubTotal.ToString("N0") ₫</span></div>
                        <div class="flex justify-between"><span>Phí vận chuyển</span><span>@order.ShippingFee.ToString("N0") ₫</span></div>
                        <div class="flex justify-between"><span>Giảm giá</span><span class="text-red-500">-@order.Discount.ToString("N0") ₫</span></div>
                        <div class="flex justify-between"><span>Phương thức</span><span>@GetPaymentMethod(order.PaymentMethod)</span></div>
                        <div class="flex justify-between"><span>Thanh toán</span><span class="@GetPaymentStatusClass(order.PaymentStatus)">@GetPaymentStatusText(order.PaymentStatus)</span></div>
                        <div class="border-t pt-2 flex justify-between font-bold text-lg"><span>Tổng cộng</span><span class="text-blue-600">@order.TotalAmount.ToString("N0") ₫</span></div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow p-6">
                    <h3 class="text-sm font-bold uppercase text-gray-600 mb-4">Ghi chú</h3>
                    @if(string.IsNullOrWhiteSpace(order.Note))
                    {
                        <p class="text-xs text-gray-500 italic">Không có ghi chú nào.</p>
                    }
                    else
                    {
                        <p class="text-sm">@order.Note</p>
                    }
                </div>
                @if(order.Status == 0 || order.Status == 1 || order.Status == 2)
                {
                    <div class="bg-white rounded-xl shadow p-6">
                        <h3 class="text-sm font-bold uppercase text-gray-600 mb-4">Hành động</h3>
                        <p class="text-xs text-gray-500 mb-3">Quản lý trạng thái tiến trình đơn hàng.</p>
                        <div class="flex flex-wrap gap-2">
                            @if(order.Status == 0)
                            {
                                <button @onclick="Accept" class="px-4 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white text-sm font-medium"><i class="fa-solid fa-check mr-1"></i>Xác nhận</button>
                                <button @onclick="() => showRejectModal = true" class="px-4 py-2 rounded-lg bg-red-500 hover:bg-red-600 text-white text-sm font-medium"><i class="fa-solid fa-times mr-1"></i>Từ chối</button>
                            }
                            else if(order.Status == 1)
                            {
                                <button @onclick="Ship" class="px-4 py-2 rounded-lg bg-cyan-500 hover:bg-cyan-600 text-white text-sm font-medium"><i class="fa-solid fa-truck mr-1"></i>Giao hàng</button>
                                <button @onclick="() => showRejectModal = true" class="px-4 py-2 rounded-lg bg-red-500 hover:bg-red-600 text-white text-sm font-medium"><i class="fa-solid fa-times mr-1"></i>Hủy</button>
                            }
                            else if(order.Status == 2)
                            {
                                <button @onclick="Complete" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium"><i class="fa-solid fa-flag-checkered mr-1"></i>Hoàn thành</button>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
}

@if(showRejectModal && order != null)
{
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4" @onclick="() => showRejectModal=false">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md" @onclick:stopPropagation>
            <div class="px-6 py-4 border-b flex items-center justify-between">
                <h3 class="font-semibold">Từ chối đơn hàng #@order.OrderNumber</h3>
                <button class="text-gray-400 hover:text-gray-600" @onclick="() => showRejectModal=false"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <p class="text-sm text-gray-600">Ghi lý do từ chối (tùy chọn) để lưu lại trong ghi chú của đơn hàng.</p>
                <textarea class="w-full border rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-red-500" rows="4" @bind="rejectReason" placeholder="Ví dụ: Khách yêu cầu hủy, hết hàng..."></textarea>
                <div class="flex gap-3">
                    <button class="flex-1 px-4 py-2 rounded-lg border border-gray-300 text-sm hover:bg-gray-50" @onclick="() => { showRejectModal=false; rejectReason=string.Empty; }">Hủy</button>
                    <button class="flex-1 px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white text-sm" @onclick="Reject"><i class="fa-solid fa-check mr-1"></i>Xác nhận từ chối</button>
                </div>
            </div>
        </div>
    </div>
}
