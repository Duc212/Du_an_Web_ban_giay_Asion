@page "/orders"
@inject AdminWeb.Services.OrderService OrderService
@inject AdminWeb.Services.ToastService Toast
@using DAL.DTOs.Orders.Res

<PageTitle>Đơn hàng - Asion Shop</PageTitle>

<link href="css/orders.css" rel="stylesheet" />

<div class="orders-page space-y-8">
    <!-- Metrics Grid -->
    <div class="stat-row">
        <div class="stat-card total">
            <div class="icon" aria-hidden="true">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" width="20" height="20" fill="currentColor">
                    <path d="M0 24C0 10.7 10.7 0 24 0H69.5c22.1 0 41.5 15.2 46.4 36.7L128 64H544c17.7 0 32 14.3 32 32c0 3.4-.5 6.7-1.4 9.8l-63.1 216.9c-8.5 29.2-35.4 49.3-65.7 49.3H192c-30.3 0-57.2-20.1-65.7-49.3L44.2 80H24C10.7 80 0 69.3 0 56V24zM160 464a48 48 0 1 1 96 0 48 48 0 1 1 -96 0zm288-48a48 48 0 1 1 0 96 48 48 0 1 1 0-96z" />
                </svg>
            </div>
            <div class="info"><p>Tổng đơn</p><h4>@totalOrders</h4><span class="trend up">↑ 12% tháng trước</span></div>
        </div>
        <div class="stat-card pending">
            <div class="icon" aria-hidden="true">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="20" height="20" fill="currentColor">
                    <path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM232 120v136c0 8 4 15.5 10.7 20l96 64c11 7.4 25.9 4.4 33.3-6.7s4.4-25.9-6.7-33.3L280 307.2V120c0-13.3-10.7-24-24-24s-24 10.7-24 24z" />
                </svg>
            </div>
            <div class="info"><p>Chờ xử lý</p><h4>@orders.Count(o=>o.Status==0)</h4><span class="warn">Cần xử lý</span></div>
        </div>
        <div class="stat-card shipping">
            <div class="icon" aria-hidden="true">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" width="22" height="22" fill="currentColor">
                    <path d="M48 48C21.5 48 0 69.5 0 96v80c0 26.5 21.5 48 48 48h16 16V96c0-26.5-21.5-48-48-48zM64 416a64 64 0 1 0 128 0 64 64 0 1 0 -128 0zM224 96V224H481.1c-5.4-9.4-8.7-20.1-9.5-31.5L468.4 133c-2.7-38.1-34.4-67.9-72.7-67.9H224zm416 0c0-35.3-28.7-64-64-64H416c-17.7 0-32 14.3-32 32v32H640V96zM512 416a64 64 0 1 0 128 0 64 64 0 1 0 -128 0zM640 256H480c0 35.3 28.7 64 64 64h32 32c17.7 0 32-14.3 32-32v-32z" />
                </svg>
            </div>
            <div class="info"><p>Đang giao</p><h4>@orders.Count(o=>o.Status==2)</h4><span class="note">Vận chuyển</span></div>
        </div>
        <div class="stat-card completed">
            <div class="icon" aria-hidden="true">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="20" height="20" fill="currentColor">
                    <path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM369 209L241 337c-9.4 9.4-24.6 9.4-33.9 0l-64-64c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0l47 47L335 175c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9z" />
                </svg>
            </div>
            <div class="info"><p>Hoàn thành</p><h4>@orders.Count(o=>o.Status==3)</h4><span class="success">Đã giao</span></div>
        </div>
    </div>

    <!-- Filter Bar -->
    <div class="filter-bar enhanced">
        <div class="filter-inner">
            <h2 class="filter-title">Danh sách đơn hàng</h2>
            <div class="flex items-center gap-4">
                <div class="relative filter-input-wrapper">
                    <input type="text" @bind="searchQuery" @bind:event="oninput" class="filter-input" placeholder="Tìm mã đơn, khách hàng..." />
                    <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="14" height="14" fill="currentColor" aria-hidden="true"><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352a144 144 0 1 0 0-288 144 144 0 1 0 0 288z"/></svg>
                    @if(!string.IsNullOrWhiteSpace(searchQuery))
                    {
                        <button type="button" class="filter-clear-btn" @onclick="() => { searchQuery = string.Empty; currentPage = 1; StateHasChanged(); }" aria-label="Xóa tìm kiếm">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" width="12" height="12" fill="currentColor" aria-hidden="true"><path d="M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 301.3 297.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256 342.6 150.6z"/></svg>
                        </button>
                    }
                </div>
                <select @bind="filterStatus" class="filter-select">
                    <option value="all">Tất cả trạng thái</option>
                    <option value="pending">Chờ xử lý</option>
                    <option value="processing">Đang xử lý</option>
                    <option value="shipping">Đang giao</option>
                    <option value="completed">Hoàn thành</option>
                    <option value="cancelled">Đã hủy</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Orders Management -->
    <div class="orders-panel full-width-edge">
        <div class="relative flex flex-col bg-white shadow-xl rounded-none md:rounded-2xl">
            <!-- Orders Table (Restyled) -->
            <div class="flex-auto p-6">
                <div class="overflow-x-auto rounded-lg border border-gray-200 bg-white shadow-sm">
                    <table class="orders-table w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0 z-10">
                            <tr>
                                <th scope="col" class="px-5 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Mã đơn</th>
                                <th scope="col" class="px-5 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Khách hàng</th>
                                <th scope="col" class="px-5 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Ngày đặt</th>
                                <th scope="col" class="px-5 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Tổng tiền</th>
                                <th scope="col" class="px-5 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Trạng thái</th>
                                <th scope="col" class="px-5 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Thao tác</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100 bg-white">
                            @foreach (var order in GetPaginatedOrders())
                            {
                                <tr class="group hover:bg-gray-50 transition">
                                    <td class="px-5 py-4 whitespace-nowrap">
                                        <span class="inline-flex items-center gap-1 text-sm font-bold text-blue-600">
                                            <svg class="text-blue-500" style="width:11px;height:11px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" fill="currentColor" aria-hidden="true"><path d="M64 0C46.3 0 32 14.3 32 32V480c0 12.9 7.8 24.6 19.9 29.6s25.7 2.2 35.5-6.9l25.5-23.1 25.5 23.1c12.2 11 30.5 11 42.7 0l25.5-23.1 25.5 23.1c12.2 11 30.5 11 42.7 0l25.5-23.1 25.5 23.1c9.8 9 23.4 11.9 35.5 6.9S352 492.9 352 480V32c0-17.7-14.3-32-32-32H64zM96 96h192c17.7 0 32 14.3 32 32v32c0 17.7-14.3 32-32 32H96c-17.7 0-32-14.3-32-32v-32c0-17.7 14.3-32 32-32zm0 160h192c17.7 0 32 14.3 32 32v32c0 17.7-14.3 32-32 32H96c-17.7 0-32-14.3-32-32v-32c0-17.7 14.3-32 32-32z"/></svg>#@order.OrderNumber
                                        </span>
                                    </td>
                                    <td class="px-5 py-4">
                                        <div class="flex items-center">
                                            <div class="flex-shrink-0">
                                                <div class="w-10 h-10 rounded-full bg-blue-600/90 flex items-center justify-center text-white text-sm font-semibold shadow-inner">
                                                    @order.ReceiverName.Substring(0,1)
                                                </div>
                                            </div>
                                            <div class="ml-3">
                                                <p class="text-sm font-medium text-gray-900">@order.ReceiverName</p>
                                                <p class="text-xs text-gray-500">@order.ReceiverPhone</p>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-5 py-4">
                                        <p class="text-sm text-gray-800">@order.CreatedAt.ToString("dd/MM/yyyy")</p>
                                        <p class="text-xs text-gray-500">@order.CreatedAt.ToString("HH:mm")</p>
                                    </td>
                                    <td class="px-5 py-4 text-right">
                                        <span class="text-sm font-semibold text-gray-800">@order.TotalAmount.ToString("N0") ₫</span>
                                    </td>
                                    <td class="px-5 py-4 text-center">
                                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold @GetStatusClass(order.Status) shadow-sm">
                                            @GetStatusText(order.Status)
                                        </span>
                                    </td>
                                    <td class="px-5 py-4 text-center">
                                        <div class="flex items-center justify-center gap-1">
                                            <button @onclick="() => ViewOrderDetail(order.OrderId)" class="action-btn btn-view" title="Chi tiết (Xem)">
                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" width="16" height="16" fill="currentColor" aria-hidden="true"><path d="M572.52 241.4C518.9 135.59 407.81 64 288 64 168.19 64 57.1 135.59 3.48 241.4a32.35 32.35 0 0 0 0 29.2C57.1 376.41 168.19 448 288 448c119.81 0 230.9-71.59 284.52-177.4a32.35 32.35 0 0 0 0-29.2zM288 400c-97 0-176-79-176-176S191 48 288 48s176 79 176 176-79 176-176 176zm0-304a128 128 0 1 0 128 128A128 128 0 0 0 288 96z"/></svg>
                                            </button>
                                            @if (order.Status == 0)
                                            {
                                                <button @onclick="() => AcceptOrder(order.OrderId)" class="action-btn btn-accept" title="Chấp nhận (✔)">
                                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="14" height="14" fill="currentColor" aria-hidden="true"><path d="M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z"/></svg>
                                                </button>
                                                <button @onclick="() => RejectOrder(order.OrderId)" class="action-btn btn-reject" title="Hủy / Từ chối (✖)">
                                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" width="14" height="14" fill="currentColor" aria-hidden="true"><path d="M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 301.3 297.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256 342.6 150.6z"/></svg>
                                                </button>
                                            }
                                            @if (order.Status == 1)
                                            {
                                                <button @onclick="() => ShipOrder(order.OrderId)" class="action-btn btn-ship" title="Giao hàng">
                                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" width="16" height="16" fill="currentColor" aria-hidden="true"><path d="M48 48C21.5 48 0 69.5 0 96v80c0 26.5 21.5 48 48 48h16 16V96c0-26.5-21.5-48-48-48zM64 416a64 64 0 1 0 128 0 64 64 0 1 0 -128 0zm288-320H224v128h256c0-53-43-96-96-96zm160 96c0 53-43 96-96 96h-64V96h64c53 0 96 43 96 96zM512 416a64 64 0 1 0 128 0 64 64 0 1 0 -128 0z"/></svg>
                                                </button>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pagination -->
            <div class="mt-6 flex justify-center">
                <Pagination CurrentPage="@currentPage" TotalItems="@filteredCount" ItemsPerPage="@pageSize" OnPageChanged="OnPageChanged" />
            </div>
        </div>
    </div>
</div>

<OrderDetailDialog Show="@showDetailModal" Order="@selectedOrder" OnClose="CloseModal" OnStatusChanged="ReloadOrders" />

@code {
    private string searchQuery = string.Empty;
    private string filterStatus = "all";
    private bool showDetailModal = false;
    private GetOrderRes? selectedOrder;

    private List<GetOrderRes> orders = new();

    private int currentPage = 1;
    private int pageSize = 5;
    private int filteredCount = 0;
    private int totalOrders = 0;

    protected override async Task OnInitializedAsync()
    {
        orders = await OrderService.GetOrdersAsync();
        totalOrders = orders.Count;
        UpdateFilteredCount();
    }

    private IEnumerable<GetOrderRes> GetFilteredOrders()
    {
        var filtered = orders.AsEnumerable();

        if (!string.IsNullOrWhiteSpace(searchQuery))
        {
            filtered = filtered.Where(o =>
                o.OrderId.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ||
                o.ReceiverName.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ||
                o.ReceiverPhone.Contains(searchQuery));
        }

        if (filterStatus != "all")
        {
            var statusInt = filterStatus switch
            {
                "pending" => 0,
                "processing" => 1,
                "shipping" => 2,
                "completed" => 3,
                "cancelled" => 4,
                _ => -1
            };
            filtered = filtered.Where(o => o.Status == statusInt);
        }

        return filtered.OrderByDescending(o => o.CreatedAt);
    }

    private IEnumerable<GetOrderRes> GetPaginatedOrders()
    {
        var data = GetFilteredOrders().ToList();
        filteredCount = data.Count;
        var skip = (currentPage - 1) * pageSize;
        return data.Skip(skip).Take(pageSize);
    }

    private void UpdateFilteredCount()
    {
        filteredCount = GetFilteredOrders().Count();
    }

    private string GetStatusClass(int status) => status switch
    {
        0 => "bg-orange-100 text-orange-600",
        1 => "bg-blue-100 text-blue-600",
        2 => "bg-cyan-100 text-cyan-600",
        3 => "bg-emerald-100 text-emerald-600",
        4 => "bg-red-100 text-red-600",
        _ => "bg-gray-100 text-gray-600"
    };

    private string GetStatusText(int status) => status switch
    {
        0 => "Chờ xử lý",
        1 => "Đang xử lý",
        2 => "Đang giao",
        3 => "Hoàn thành",
        4 => "Đã hủy",
        _ => "Không xác định"
    };

    private async void ViewOrderDetail(string orderId)
    {
        selectedOrder = await OrderService.GetOrderAsync(orderId);
        if (selectedOrder != null) showDetailModal = true;
        StateHasChanged();
    }

    private void CloseModal() => showDetailModal = false;

    private async Task ReloadOrders()
    {
        orders = await OrderService.GetOrdersAsync();
        UpdateFilteredCount();
        StateHasChanged();
    }

    private async void AcceptOrder(string orderId)
    {
        var success = await OrderService.UpdateStatusAsync(orderId, 1);
        if (success)
        {
            Toast.Success("Đơn đã chuyển sang trạng thái xử lý");
            orders = await OrderService.GetOrdersAsync();
            UpdateFilteredCount();
        }
        StateHasChanged();
    }

    private async void RejectOrder(string orderId)
    {
        var success = await OrderService.UpdateStatusAsync(orderId, 4);
        if (success)
        {
            Toast.Error("Đơn đã bị hủy");
            orders = await OrderService.GetOrdersAsync();
            UpdateFilteredCount();
        }
        StateHasChanged();
    }

    private async void ShipOrder(string orderId)
    {
        var success = await OrderService.UpdateStatusAsync(orderId, 2);
        if (success)
        {
            Toast.Info("Đơn đang được giao");
            orders = await OrderService.GetOrdersAsync();
            UpdateFilteredCount();
        }
        StateHasChanged();
    }

    private async Task OnPageChanged(int page)
    {
        currentPage = page;
        await InvokeAsync(StateHasChanged);
    }
}
