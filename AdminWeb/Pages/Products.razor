@page "/products"
@inject ProductService ProductService
@inject CategoryService CategoryService
@inject BrandService BrandService
@inject ToastService ToastService
@inject IJSRuntime JSRuntime

<PageTitle>Sản phẩm - Asion Shop</PageTitle>

<link href="css/products.css" rel="stylesheet" />

<div class="products-container">
    <!-- Header with Statistics -->
    <div class="stats-bar">
        <div class="stat-card">
            <div class="stat-icon stat-icon-blue">
                <i class="fas fa-box"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">@statistics?.TotalProducts</div>
                <div class="stat-label">Tổng sản phẩm</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon stat-icon-green">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">@statistics?.ActiveProducts</div>
                <div class="stat-label">Đang bán</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon stat-icon-orange">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">@statistics?.LowStockProducts</div>
                <div class="stat-label">Sắp hết hàng</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon stat-icon-red">
                <i class="fas fa-times-circle"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">@statistics?.OutOfStockProducts</div>
                <div class="stat-label">Hết hàng</div>
            </div>
        </div>
    </div>

    <!-- Filter Bar -->
    <div class="filter-bar">
        <div class="filter-inner">
            <div class="filter-left">
                <h2 class="page-title">Danh sách sản phẩm</h2>
            </div>
            <div class="filter-right">
                <div class="filter-group">
                    <input type="text" 
                           class="filter-input" 
                           placeholder="Tìm kiếm sản phẩm..." 
                           @bind="searchKeyword"
                           @bind:event="oninput"
                           @onkeyup="OnSearchKeyUp" />
                    <i class="fas fa-search filter-input-icon"></i>
                </div>

                <div class="filter-group">
                    <select class="filter-select" @bind="selectedCategoryId" @bind:after="OnFilterChanged">
                        <option value="0">Tất cả danh mục</option>
                        @foreach (var category in categories)
                        {
                            <option value="@category.CategoryID">@category.CategoryName</option>
                        }
                    </select>
                    <i class="fas fa-layer-group filter-select-icon"></i>
                </div>

                <div class="filter-group">
                    <select class="filter-select" @bind="selectedBrandId" @bind:after="OnFilterChanged">
                        <option value="0">Tất cả thương hiệu</option>
                        @foreach (var brand in brands)
                        {
                            <option value="@brand.BrandID">@brand.BrandName</option>
                        }
                    </select>
                    <i class="fas fa-tags filter-select-icon"></i>
                </div>

                <button class="btn-add" @onclick="OpenAddProductModal">
                    <i class="fas fa-plus"></i>
                    Thêm sản phẩm
                </button>
            </div>
        </div>
    </div>

    <!-- Products Table -->
    <div class="table-container">
        @if (isLoading)
        {
            <div class="loading-container">
                <div class="spinner"></div>
                <p>Đang tải dữ liệu...</p>
            </div>
        }
        else if (products == null || !products.Any())
        {
            <div class="no-data">
                <i class="fas fa-box-open"></i>
                <p>Không có sản phẩm nào</p>
            </div>
        }
        else
        {
            <table class="products-table">
                <thead>
                    <tr>
                        <th>Hình ảnh</th>
                        <th>Tên sản phẩm</th>
                        <th>Danh mục</th>
                        <th>Thương hiệu</th>
                        <th>Giới tính</th>
                        <th>Giá bán</th>
                        <th>Tồn kho</th>
                        <th>Variants</th>
                        <th>Ngày tạo</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var product in products)
                    {
                        <tr>
                            <td>
                                <img src="@product.ImageUrl" alt="@product.Name" class="product-image" />
                            </td>
                            <td>
                                <div class="product-name">@product.Name</div>
                                <div class="product-description">@(product.Description.Length > 50 ? product.Description.Substring(0, 50) + "..." : product.Description)</div>
                            </td>
                            <td>
                                <span class="badge badge-category">@product.CategoryName</span>
                            </td>
                            <td>
                                <span class="badge badge-brand">@product.BrandName</span>
                            </td>
                            <td>
                                <span class="badge badge-gender">@product.GenderName</span>
                            </td>
                            <td>
                                @if (product.MinPrice == product.MaxPrice)
                                {
                                    <div class="product-price">@product.MinPrice.ToString("N0") đ</div>
                                }
                                else
                                {
                                    <div class="product-price">@product.MinPrice.ToString("N0") đ - @product.MaxPrice.ToString("N0") đ</div>
                                }
                            </td>
                            <td>
                                <span class="stock-badge @(product.TotalStock == 0 ? "stock-out" : product.TotalStock < 20 ? "stock-low" : "stock-good")">
                                    @product.TotalStock
                                </span>
                            </td>
                            <td>
                                <span class="variant-count">@product.VariantCount variants</span>
                            </td>
                            <td>
                                <div class="date-text">@product.CreatedAt.ToString("dd/MM/yyyy")</div>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="action-btn btn-view" title="Xem chi tiết" @onclick="() => ViewProductDetail(product.ProductID)">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="action-btn btn-edit" title="Chỉnh sửa" @onclick="() => OpenEditModal(product.ProductID)">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="action-btn btn-delete" title="Xóa" @onclick="() => OpenDeleteConfirm(product)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    </div>

    <!-- Pagination -->
    @if (totalPages > 1)
    {
        <div class="pagination-container">
            <button class="pagination-btn" @onclick="PreviousPage" disabled="@(currentPage == 1)">
                <i class="fas fa-chevron-left"></i>
            </button>

            @for (int i = 1; i <= totalPages; i++)
            {
                var pageNumber = i;
                <button class="pagination-btn @(currentPage == pageNumber ? "active" : "")" 
                        @onclick="() => GoToPage(pageNumber)">
                    @pageNumber
                </button>
            }

            <button class="pagination-btn" @onclick="NextPage" disabled="@(currentPage == totalPages)">
                <i class="fas fa-chevron-right"></i>
            </button>

            <span class="pagination-info">
                Trang @currentPage / @totalPages (Tổng: @totalRecords sản phẩm)
            </span>
        </div>
    }
</div>

<!-- View Detail Modal -->
@if (showDetailModal && selectedProduct != null)
{
    <div class="modal show" @onclick="CloseDetailModal">
        <div class="modal-dialog modal-xl" @onclick:stopPropagation="true">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">
                        <i class="fas fa-info-circle"></i>
                        Chi tiết sản phẩm
                    </h3>
                    <button class="modal-close" @onclick="CloseDetailModal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    @if (isLoadingDetail)
                    {
                        <div class="loading-container">
                            <div class="spinner"></div>
                            <p>Đang tải chi tiết...</p>
                        </div>
                    }
                    else if (productDetail != null)
                    {
                        <div class="detail-grid">
                            <div class="detail-section">
                                <h4>Thông tin cơ bản</h4>
                                <div class="detail-row">
                                    <span class="detail-label">Tên sản phẩm:</span>
                                    <span class="detail-value">@productDetail.Name</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Mô tả:</span>
                                    <span class="detail-value">@productDetail.Description</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Danh mục:</span>
                                    <span class="detail-value">@productDetail.CategoryName</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Thương hiệu:</span>
                                    <span class="detail-value">@productDetail.BrandName</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Giới tính:</span>
                                    <span class="detail-value">@productDetail.GenderName</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Ngày tạo:</span>
                                    <span class="detail-value">@productDetail.CreatedAt.ToString("dd/MM/yyyy HH:mm")</span>
                                </div>
                            </div>

                            <div class="detail-section">
                                <h4>Hình ảnh chính</h4>
                                <img src="@productDetail.ImageUrl" alt="@productDetail.Name" class="detail-image" />
                            </div>
                        </div>

                        <div class="detail-section">
                            <h4>Danh sách Variants (@productDetail.Variants.Count)</h4>
                            <div class="variants-grid">
                                @foreach (var variant in productDetail.Variants)
                                {
                                    <div class="variant-card">
                                        <div class="variant-color">
                                            <span class="color-box" style="background-color: @variant.ColorHex"></span>
                                            @variant.ColorName
                                        </div>
                                        <div class="variant-size">Size: <strong>@variant.SizeValue</strong></div>
                                        <div class="variant-price">
                                            <div>Giá nhập: <strong>@variant.ImportPrice.ToString("N0") đ</strong></div>
                                            <div>Giá bán: <strong class="text-red">@variant.SellingPrice.ToString("N0") đ</strong></div>
                                        </div>
                                        <div class="variant-stock">
                                            Tồn kho: <span class="stock-badge @(variant.StockQuantity == 0 ? "stock-out" : variant.StockQuantity < 10 ? "stock-low" : "stock-good")">
                                                @variant.StockQuantity
                                            </span>
                                        </div>
                                        <div class="variant-status">
                                            Trạng thái: <span class="badge @(variant.Status == "Active" ? "badge-success" : "badge-danger")">@variant.Status</span>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>

                        <div class="detail-section">
                            <h4>Thư viện ảnh (@productDetail.Images.Count)</h4>
                            <div class="images-grid">
                                @foreach (var image in productDetail.Images.OrderBy(i => i.DisplayOrder))
                                {
                                    <div class="image-item">
                                        <img src="@image.ImageUrl" alt="@image.ColorName" />
                                        <div class="image-info">
                                            <div>@image.ColorName</div>
                                            <div class="image-type">@image.ImageType</div>
                                            @if (image.IsDefault)
                                            {
                                                <span class="badge badge-primary">Mặc định</span>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" @onclick="CloseDetailModal">Đóng</button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Delete Confirm Modal -->
@if (showDeleteConfirm && productToDelete != null)
{
    <div class="modal show" @onclick="CloseDeleteConfirm">
        <div class="modal-dialog modal-sm" @onclick:stopPropagation="true">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">
                        <i class="fas fa-exclamation-triangle text-warning"></i>
                        Xác nhận xóa
                    </h3>
                    <button class="modal-close" @onclick="CloseDeleteConfirm">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Bạn có chắc chắn muốn xóa sản phẩm <strong>@productToDelete.Name</strong>?</p>
                    <p class="text-danger">⚠️ Hành động này sẽ xóa luôn tất cả variants và hình ảnh của sản phẩm!</p>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" @onclick="CloseDeleteConfirm">Hủy</button>
                    <button class="btn-danger" @onclick="ConfirmDelete" disabled="@isDeleting">
                        @if (isDeleting)
                        {
                            <span>Đang xóa...</span>
                        }
                        else
                        {
                            <i class="fas fa-trash"></i>
                            <span>Xóa sản phẩm</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<Toast />

@code {
    // State variables
    private List<ProductDTO> products = new();
    private List<CategoryDto> categories = new();
    private List<BrandDto> brands = new();
    private ProductStatisticsDTO? statistics;
    
    private bool isLoading = false;
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalRecords = 0;
    private int totalPages => (int)Math.Ceiling((double)totalRecords / pageSize);

    // Filter variables
    private string searchKeyword = "";
    private int selectedCategoryId = 0;
    private int selectedBrandId = 0;
    private System.Threading.Timer? searchTimer;

    // Modal states
    private bool showDetailModal = false;
    private bool showDeleteConfirm = false;
    private bool isLoadingDetail = false;
    private bool isDeleting = false;
    
    private ProductDTO? selectedProduct = null;
    private ProductDetailDTO? productDetail = null;
    private ProductDTO? productToDelete = null;

    protected override async Task OnInitializedAsync()
    {
        await LoadDropdownData();
        await LoadStatistics();
        await LoadProducts();
    }

    private async Task LoadDropdownData()
    {
        var categoriesResponse = await CategoryService.GetListCategoryAsync();
        if (categoriesResponse.Success)
        {
            categories = categoriesResponse.Data;
        }

        var brandsResponse = await BrandService.GetListBrandAsync();
        if (brandsResponse.Success)
        {
            brands = brandsResponse.Data;
        }
    }

    private async Task LoadStatistics()
    {
        var response = await ProductService.GetStatisticsAsync();
        if (response.Success && response.Data != null)
        {
            var data = response.Data;
            statistics = new ProductStatisticsDTO
            {
                TotalProducts = data.TotalProducts,
                ActiveProducts = data.ActiveProducts,
                OutOfStockProducts = data.OutOfStockProducts,
                LowStockProducts = data.LowStockProducts,
                TotalInventoryValue = data.TotalInventoryValue,
                CategoryStats = data.CategoryStats?.Select(x => new ProductStatisticsDTO.CategoryStatistics
                {
                    CategoryID = x.CategoryID,
                    CategoryName = x.CategoryName,
                    ProductCount = x.ProductCount,
                    TotalStock = x.TotalStock
                }).ToList() ?? new List<ProductStatisticsDTO.CategoryStatistics>(),
                BrandStats = data.BrandStats?.Select(x => new ProductStatisticsDTO.BrandStatistics
                {
                    BrandID = x.BrandID,
                    BrandName = x.BrandName,
                    ProductCount = x.ProductCount,
                    TotalStock = x.TotalStock
                }).ToList() ?? new List<ProductStatisticsDTO.BrandStatistics>()
            };
        }
    }

    private async Task LoadProducts()
    {
        isLoading = true;
        StateHasChanged();

        var response = await ProductService.GetAllProductsAsync(
            pageIndex: currentPage,
            pageSize: pageSize,
            keyword: searchKeyword,
            categoryId: selectedCategoryId > 0 ? selectedCategoryId : null,
            brandId: selectedBrandId > 0 ? selectedBrandId : null
        );

        if (response.Success)
        {
            products = response.Data;
            totalRecords = response.TotalRecords;
        }
        else
        {
            ToastService.ShowError(response.Message);
        }

        isLoading = false;
        StateHasChanged();
    }

    private void OnSearchKeyUp()
    {
        searchTimer?.Dispose();
        searchTimer = new System.Threading.Timer(async _ =>
        {
            currentPage = 1;
            await InvokeAsync(async () =>
            {
                await LoadProducts();
            });
        }, null, 500, Timeout.Infinite);
    }

    private async Task OnFilterChanged()
    {
        currentPage = 1;
        await LoadProducts();
    }

    private async Task PreviousPage()
    {
        if (currentPage > 1)
        {
            currentPage--;
            await LoadProducts();
        }
    }

    private async Task NextPage()
    {
        if (currentPage < totalPages)
        {
            currentPage++;
            await LoadProducts();
        }
    }

    private async Task GoToPage(int page)
    {
        currentPage = page;
        await LoadProducts();
    }

    // Modal methods - TO BE IMPLEMENTED
    private async Task OpenAddProductModal()
    {
        ToastService.ShowInfo("Chức năng thêm sản phẩm đang phát triển...");
        // TODO: Implement add product modal
    }

    private async Task ViewProductDetail(int productId)
    {
        selectedProduct = products.FirstOrDefault(p => p.ProductID == productId);
        if (selectedProduct == null) return;

        showDetailModal = true;
        isLoadingDetail = true;
        await JSRuntime.InvokeVoidAsync("eval", "document.body.classList.add('modal-open')");
        StateHasChanged();

        var response = await ProductService.GetProductDetailAsync(productId);
        if (response.Success && response.Data != null)
        {
            productDetail = response.Data;
        }
        else
        {
            ToastService.ShowError(response.Message);
        }

        isLoadingDetail = false;
        StateHasChanged();
    }

    private async Task CloseDetailModal()
    {
        showDetailModal = false;
        selectedProduct = null;
        productDetail = null;
        await JSRuntime.InvokeVoidAsync("eval", "document.body.classList.remove('modal-open')");
    }

    private async Task OpenEditModal(int productId)
    {
        ToastService.ShowInfo("Chức năng chỉnh sửa đang phát triển...");
        // TODO: Implement edit product modal
    }

    private async Task OpenDeleteConfirm(ProductDTO product)
    {
        productToDelete = product;
        showDeleteConfirm = true;
        await JSRuntime.InvokeVoidAsync("eval", "document.body.classList.add('modal-open')");
    }

    private async Task CloseDeleteConfirm()
    {
        showDeleteConfirm = false;
        productToDelete = null;
        await JSRuntime.InvokeVoidAsync("eval", "document.body.classList.remove('modal-open')");
    }

    private async Task ConfirmDelete()
    {
        if (productToDelete == null) return;

        isDeleting = true;
        StateHasChanged();

        var response = await ProductService.DeleteProductAsync(productToDelete.ProductID);
        
        if (response.Success)
        {
            ToastService.ShowSuccess($"Đã xóa sản phẩm {productToDelete.Name} thành công!");
            await CloseDeleteConfirm();
            currentPage = 1;
            await LoadProducts();
            await LoadStatistics();
        }
        else
        {
            ToastService.ShowError(response.Message);
        }

        isDeleting = false;
        StateHasChanged();
    }

    public void Dispose()
    {
        searchTimer?.Dispose();
    }
}
