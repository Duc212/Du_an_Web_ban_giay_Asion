@using DAL.DTOs.Orders.Res
@inject AdminWeb.Services.ToastService Toast
@inject IJSRuntime JS

@if (Show && Order != null)
{
    <div class="modal-overlay" @onclick="HandleClose" @onclick:stopPropagation>
        <div class="modal-dialog" @onclick:stopPropagation @ref="modalElement">
            <div class="modal-header">
                <div class="header-info">
                    <h2 class="modal-title">Chi tiết đơn hàng</h2>
                    <span class="order-code-badge">@Order.OrderCode</span>
                </div>
                <button class="btn-close" @onclick="HandleClose">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" fill="currentColor">
                        <path d="M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 301.3 297.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256 342.6 150.6z"/>
                    </svg>
                </button>
            </div>

            <div class="modal-body">
                <!-- Order Timeline -->
                <div class="detail-section timeline-section">
                    <h3 class="section-title">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor">
                            <path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/>
                        </svg>
                        Lịch sử đơn hàng
                    </h3>
                    <div class="timeline">
                        @foreach (var history in Order.StatusHistory.OrderByDescending(h => h.ChangedAt))
                        {
                            <div class="timeline-item @(history.Status == Order.Status ? "active" : "")">
                                <div class="timeline-marker"></div>
                                <div class="timeline-content">
                                    <div class="timeline-header">
                                        <span class="timeline-status">@history.StatusText</span>
                                        <span class="timeline-date">@history.ChangedAt.ToString("dd/MM/yyyy HH:mm")</span>
                                    </div>
                                    @if (!string.IsNullOrEmpty(history.Note))
                                    {
                                        <p class="timeline-note">@history.Note</p>
                                    }
                                    <span class="timeline-user">Bởi: @history.UpdatedBy</span>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <!-- Main Content Grid -->
                <div class="content-grid">
                    <!-- Left Column -->
                    <div class="left-column">
                        <!-- Customer Info -->
                        <div class="detail-section">
                            <h3 class="section-title">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" fill="currentColor">
                                    <path d="M224 256A128 128 0 1 0 224 0a128 128 0 1 0 0 256zm-45.7 48C79.8 304 0 383.8 0 482.3C0 498.7 13.3 512 29.7 512H418.3c16.4 0 29.7-13.3 29.7-29.7C448 383.8 368.2 304 269.7 304H178.3z"/>
                                </svg>
                                Thông tin khách hàng
                            </h3>
                            <div class="info-card">
                                <div class="customer-avatar-large">@Order.Customer.FullName.Substring(0, 1).ToUpper()</div>
                                <div class="info-rows">
                                    <div class="info-row">
                                        <span class="info-label">Họ tên:</span>
                                        <span class="info-value">@Order.Customer.FullName</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Email:</span>
                                        <span class="info-value">@Order.Customer.Email</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Điện thoại:</span>
                                        <span class="info-value">@Order.Customer.Phone</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Username:</span>
                                        <span class="info-value">@Order.Customer.Username</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Shipping Info -->
                        <div class="detail-section">
                            <h3 class="section-title">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" fill="currentColor">
                                    <path d="M215.7 499.2C267 435 384 279.4 384 192C384 86 298 0 192 0S0 86 0 192c0 87.4 117 243 168.3 307.2c12.3 15.3 35.1 15.3 47.4 0zM192 128a64 64 0 1 1 0 128 64 64 0 1 1 0-128z"/>
                                </svg>
                                Địa chỉ giao hàng
                            </h3>
                            <div class="info-card">
                                <div class="info-rows">
                                    <div class="info-row">
                                        <span class="info-label">Người nhận:</span>
                                        <span class="info-value">@Order.ShippingInfo.ReceiverName</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Số điện thoại:</span>
                                        <span class="info-value">@Order.ShippingInfo.ReceiverPhone</span>
                                    </div>
                                    <div class="info-row full-width">
                                        <span class="info-label">Địa chỉ:</span>
                                        <span class="info-value">@Order.ShippingInfo.FullAddress</span>
                                    </div>
                                    @if (!string.IsNullOrEmpty(Order.ShippingInfo.Note))
                                    {
                                        <div class="info-row full-width">
                                            <span class="info-label">Ghi chú:</span>
                                            <span class="info-value note">@Order.ShippingInfo.Note</span>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>

                        <!-- Payment & Shipment Info -->
                        <div class="detail-section">
                            <h3 class="section-title">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" fill="currentColor">
                                    <path d="M64 64C28.7 64 0 92.7 0 128v64c0 8.8 7.4 15.7 15.7 18.6C34.5 217.1 48 235 48 256s-13.5 38.9-32.3 45.4C7.4 304.3 0 311.2 0 320v64c0 35.3 28.7 64 64 64H512c35.3 0 64-28.7 64-64V320c0-8.8-7.4-15.7-15.7-18.6C541.5 294.9 528 277 528 256s13.5-38.9 32.3-45.4c8.3-2.9 15.7-9.8 15.7-18.6V128c0-35.3-28.7-64-64-64H64zm64 112l0 160c0 8.8 7.2 16 16 16H432c8.8 0 16-7.2 16-16V176c0-8.8-7.2-16-16-16H144c-8.8 0-16 7.2-16 16zM96 160c0-17.7 14.3-32 32-32H448c17.7 0 32 14.3 32 32V352c0 17.7-14.3 32-32 32H128c-17.7 0-32-14.3-32-32V160z"/>
                                </svg>
                                Thanh toán & Vận chuyển
                            </h3>
                            <div class="info-card">
                                <div class="info-rows">
                                    <div class="info-row">
                                        <span class="info-label">Phương thức TT:</span>
                                        <span class="info-value badge badge-payment">@Order.Payment.PaymentMethodText</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Trạng thái TT:</span>
                                        <span class="info-value badge @GetPaymentStatusClass(Order.Payment.PaymentStatus)">
                                            @Order.Payment.PaymentStatusText
                                        </span>
                                    </div>
                                    @if (Order.Payment.PaidAt.HasValue)
                                    {
                                        <div class="info-row">
                                            <span class="info-label">Thanh toán lúc:</span>
                                            <span class="info-value">@Order.Payment.PaidAt.Value.ToString("dd/MM/yyyy HH:mm")</span>
                                        </div>
                                    }
                                    @if (!string.IsNullOrEmpty(Order.Shipment.ShippingProvider))
                                    {
                                        <div class="info-row">
                                            <span class="info-label">Đơn vị vận chuyển:</span>
                                            <span class="info-value">@Order.Shipment.ShippingProvider</span>
                                        </div>
                                    }
                                    @if (!string.IsNullOrEmpty(Order.Shipment.TrackingNumber))
                                    {
                                        <div class="info-row">
                                            <span class="info-label">Mã vận đơn:</span>
                                            <span class="info-value tracking">@Order.Shipment.TrackingNumber</span>
                                        </div>
                                    }
                                    @if (Order.Shipment.EstimatedDelivery.HasValue)
                                    {
                                        <div class="info-row">
                                            <span class="info-label">Dự kiến giao:</span>
                                            <span class="info-value">@Order.Shipment.EstimatedDelivery.Value.ToString("dd/MM/yyyy")</span>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column -->
                    <div class="right-column">
                        <!-- Order Items -->
                        <div class="detail-section">
                            <h3 class="section-title">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" fill="currentColor">
                                    <path d="M0 24C0 10.7 10.7 0 24 0H69.5c22.1 0 41.5 15.2 46.4 36.7L128 64H544c17.7 0 32 14.3 32 32c0 3.4-.5 6.7-1.4 9.8l-63.1 216.9c-8.5 29.2-35.4 49.3-65.7 49.3H192c-30.3 0-57.2-20.1-65.7-49.3L44.2 80H24C10.7 80 0 69.3 0 56V24z"/>
                                </svg>
                                Sản phẩm (@Order.Items.Count)
                            </h3>
                            <div class="product-list">
                                @foreach (var item in Order.Items)
                                {
                                    <div class="product-item">
                                        <div class="product-image">
                                            <img src="@item.ImageUrl" alt="@item.ProductName" />
                                        </div>
                                        <div class="product-details">
                                            <h4 class="product-name">@item.ProductName</h4>
                                            <p class="product-brand">@item.BrandName</p>
                                            <div class="product-variant">
                                                <span class="variant-item">Màu: @item.ColorName</span>
                                                <span class="variant-separator">•</span>
                                                <span class="variant-item">Size: @item.SizeName</span>
                                            </div>
                                            <div class="product-pricing">
                                                <span class="product-quantity">x@item.Quantity</span>
                                                <span class="product-price">@item.UnitPrice.ToString("N0")₫</span>
                                            </div>
                                        </div>
                                        <div class="product-subtotal">
                                            @item.Subtotal.ToString("N0")₫
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>

                        <!-- Order Summary -->
                        <div class="detail-section">
                            <h3 class="section-title">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" fill="currentColor">
                                    <path d="M64 0C28.7 0 0 28.7 0 64V448c0 35.3 28.7 64 64 64H320c35.3 0 64-28.7 64-64V160H256c-17.7 0-32-14.3-32-32V0H64zM256 0V128H384L256 0zM80 64h64c8.8 0 16 7.2 16 16s-7.2 16-16 16H80c-8.8 0-16-7.2-16-16s7.2-16 16-16zm0 64h64c8.8 0 16 7.2 16 16s-7.2 16-16 16H80c-8.8 0-16-7.2-16-16s7.2-16 16-16zm54.2 253.8c-6.1 20.3-24.8 34.2-46 34.2H80c-8.8 0-16-7.2-16-16s7.2-16 16-16h8.2c7.1 0 13.3-4.6 15.3-11.4l14.9-49.5c3.4-11.3 13.8-19.1 25.6-19.1s22.2 7.7 25.6 19.1l11.6 38.6c7.4-6.2 16.8-9.7 26.8-9.7c15.9 0 30.4 9 37.5 23.2l4.4 8.8H304c8.8 0 16 7.2 16 16s-7.2 16-16 16H240c-6.1 0-11.6-3.4-14.3-8.8l-8.8-17.7c-1.7-3.4-5.1-5.5-8.8-5.5s-7.2 2.1-8.8 5.5l-8.8 17.7c-2.9 5.9-9.2 9.4-15.7 8.8s-12.1-5.1-13.9-11.3L144 349l-9.8 32.8z"/>
                                </svg>
                                Tổng kết đơn hàng
                            </h3>
                            <div class="summary-card">
                                <div class="summary-row">
                                    <span class="summary-label">Tạm tính:</span>
                                    <span class="summary-value">@Order.Summary.Subtotal.ToString("N0")₫</span>
                                </div>
                                <div class="summary-row">
                                    <span class="summary-label">Phí vận chuyển:</span>
                                    <span class="summary-value">@Order.Summary.ShippingFee.ToString("N0")₫</span>
                                </div>
                                @if (Order.Summary.Discount > 0)
                                {
                                    <div class="summary-row discount">
                                        <span class="summary-label">
                                            Giảm giá
                                            @if (Order.Voucher != null && !string.IsNullOrEmpty(Order.Voucher.VoucherCode))
                                            {
                                                <span class="voucher-code">(@Order.Voucher.VoucherCode)</span>
                                            }
                                        </span>
                                        <span class="summary-value">-@Order.Summary.Discount.ToString("N0")₫</span>
                                    </div>
                                }
                                <div class="summary-divider"></div>
                                <div class="summary-row total">
                                    <span class="summary-label">Tổng cộng:</span>
                                    <span class="summary-value">@Order.Summary.TotalAmount.ToString("N0")₫</span>
                                </div>
                            </div>
                        </div>

                        <!-- Order Note -->
                        @if (!string.IsNullOrEmpty(Order.Note))
                        {
                            <div class="detail-section">
                                <h3 class="section-title">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor">
                                        <path d="M362.7 19.3L314.3 67.7 444.3 197.7l48.4-48.4c25-25 25-65.5 0-90.5L453.3 19.3c-25-25-65.5-25-90.5 0zm-71 71L58.6 323.5c-10.4 10.4-18 23.3-22.2 37.4L1 481.2C-1.5 489.7 .8 498.8 7 505s15.3 8.5 23.7 6.1l120.3-35.4c14.1-4.2 27-11.8 37.4-22.2L421.7 220.3 291.7 90.3z"/>
                                    </svg>
                                    Ghi chú đơn hàng
                                </h3>
                                <div class="note-card">
                                    <p>@Order.Note</p>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="HandleClose">Đóng</button>
                @if (Order.Status == 0)
                {
                    <button class="btn btn-success" @onclick="HandleConfirm">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" fill="currentColor">
                            <path d="M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z"/>
                        </svg>
                        Xác nhận đơn hàng
                    </button>
                    <button class="btn btn-danger" @onclick="HandleCancel">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" fill="currentColor">
                            <path d="M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 301.3 297.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256 342.6 150.6z"/>
                        </svg>
                        Hủy đơn hàng
                    </button>
                }
                @if (Order.Status == 1 || Order.Status == 2)
                {
                    <button class="btn btn-primary" @onclick="HandleShip">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" fill="currentColor">
                            <path d="M112 0C85.5 0 64 21.5 64 48V96H16c-8.8 0-16 7.2-16 16s7.2 16 16 16H64 272c8.8 0 16 7.2 16 16s-7.2 16-16 16H64 48c-8.8 0-16 7.2-16 16s7.2 16 16 16H64 240c8.8 0 16 7.2 16 16s-7.2 16-16 16H64 16c-8.8 0-16 7.2-16 16s7.2 16 16 16H64 208c8.8 0 16 7.2 16 16s-7.2 16-16 16H64V416c0 53 43 96 96 96s96-43 96-96H384c0 53 43 96 96 96s96-43 96-96h32c17.7 0 32-14.3 32-32s-14.3-32-32-32V288 256 237.3c0-17-6.7-33.3-18.7-45.3L512 114.7c-12-12-28.3-18.7-45.3-18.7H416V48c0-26.5-21.5-48-48-48H112z"/>
                        </svg>
                        Giao hàng
                    </button>
                }
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool Show { get; set; }
    [Parameter] public AdminOrderDetail? Order { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback OnStatusChanged { get; set; }

    private ElementReference modalElement;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (Show && Order != null)
        {
            await JS.InvokeVoidAsync("eval", @"
                document.body.style.overflow = 'hidden';
                const modalOverlay = document.querySelector('.modal-overlay');
                if (modalOverlay) {
                    modalOverlay.scrollTop = 0;
                    const modalDialog = modalOverlay.querySelector('.modal-dialog');
                    if (modalDialog) {
                        const modalBody = modalDialog.querySelector('.modal-body');
                        if (modalBody) modalBody.scrollTop = 0;
                    }
                }
            ");
        }
        else
        {
            await JS.InvokeVoidAsync("eval", "document.body.style.overflow = 'auto';");
        }
    }

    private async Task HandleClose()
    {
        await JS.InvokeVoidAsync("eval", "document.body.style.overflow = 'auto';");
        await OnClose.InvokeAsync();
    }

    private async Task HandleConfirm()
    {
        Toast.Success("Đã xác nhận đơn hàng");
        await OnStatusChanged.InvokeAsync();
        await HandleClose();
    }

    private async Task HandleCancel()
    {
        Toast.Error("Đã hủy đơn hàng");
        await OnStatusChanged.InvokeAsync();
        await HandleClose();
    }

    private async Task HandleShip()
    {
        Toast.Info("Đơn hàng đang được giao");
        await OnStatusChanged.InvokeAsync();
        await HandleClose();
    }

    private string GetPaymentStatusClass(int status) => status switch
    {
        0 => "badge-warning",
        1 => "badge-success",
        2 => "badge-info",
        3 => "badge-danger",
        _ => "badge-secondary"
    };
}
